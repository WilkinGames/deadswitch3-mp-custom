const chalk=require("chalk"),log=console.log,serverSettings=require("./settings.json"),gameInstance=require("./assets/js/game");setInterval((function(){stats.emitsPerSecond=stats.emits,stats.emits=0}),1e3);const{RateLimiterMemory:RateLimiterMemory}=require("rate-limiter-flexible"),rateLimiter=new RateLimiterMemory({points:300,duration:1}),gameLimiter=new RateLimiterMemory({points:60,duration:1}),actionLimiter=new RateLimiterMemory({points:2,duration:1}),chatLimiter=new RateLimiterMemory({points:5,duration:5});var MathUtil={Random:function(e,a){return Math.floor(Math.random()*(a-e+1))+e},RandomBoolean:function(){return Math.random()>=.5}};const Server={VERSION:"1.1.0",GAME_VERSION:"1.6.7",OFFICIAL:!0},GameData={FACTION_DELTA_FORCE:"usmc",FACTION_GSG9:"gsg9",FACTION_GIGN:"gign",FACTION_OPFOR:"opfor",FACTION_SPETSNAZ:"rus",FACTION_MILITIA:"militia",BOT_SKILL_AUTO:-1,BOT_SKILL_EASY:0,BOT_SKILL_NORMAL:1,BOT_SKILL_HARD:2,BOT_SKILL_INSANE:3,BOT_SKILL_GOD:4,MAX_LEVEL:50,MAX_PRESTIGE:10};var lobbies={},lobbyTimers={},parties={},intervals={},stats={playersConnected:0,gamesPlayed:0,peakGamesInProgress:0,peakPlayersConnected:0,emits:0,emitsPerSecond:0},chatHistory=[];log(chalk.bgBlue("Deadswitch 3 Multiplayer Server v"+Server.VERSION));var serverStartTime=Date.now();log("Started:",new Date(serverStartTime).toString()),log(serverSettings,"\n"),log(chalk.yellow("Loading modules..."));var smile=require("smile2emoji"),express=require("express"),app=express(),server=require("http").Server(app),io=require("socket.io").listen(server,{pingInterval:serverSettings.pingInterval,pingTimeout:serverSettings.pingTimeout});io.set("transports",["websocket"]),io.origins("*:*");const shared=require("./assets/json/shared.json"),sprites=require("./assets/json/sprites.json"),atlas_weapons_world=require("./assets/images/world/atlas_weapons_world.json"),weapons=require("./assets/json/weapons.json"),mods=require("./assets/json/mods.json"),perks=require("./assets/json/perks.json"),killstreaks=require("./assets/json/killstreaks.json"),game_modes=require("./assets/json/modes.json"),botnames=require("./assets/json/botnames.json"),bots=require("./assets/json/bots.json"),titlecards_soldiers=require("./assets/json/titlecards_soldiers.json"),badwords=require("./assets/json/badwords.json"),maps=require("./assets/json/maps.json");for(var allMaps=[],i=0;i<maps.length;i++){let e=maps[i].id;try{allMaps.push(require("./assets/json/maps/"+e+".json"))}catch(a){console.warn("Missing map:",e)}}log("Loaded",allMaps.length,"maps");const operations=require("./assets/json/operations.json");var operationData={};for(i=0;i<operations.length;i++){let e=operations[i];try{operationData[e]=require("./assets/json/operations/"+e+".json")}catch(a){console.warn("Missing operation:",e)}}log("Loaded",Object.keys(operationData).length,"operations");const p2=require("p2"),ngraphGraph=require("ngraph.graph"),ngraphPath=require("ngraph.path"),MongoClient=require("mongodb").MongoClient,uri=null;log(chalk.green("Done\n")),app.get("/",(function(e,a){var t=getAllSockets(),r="12px Arial",o="<head><title>Deadswitch 3 Multiplayer Server</title>";o+="<style>h1 { font-weight: 400; } body { background-color: #141414; font: "+r+"; color: #EEEEEE; } table { margin-top: 5px; font: "+r+"; border-collapse: collapse; background-color: #00000033 } th { text-align: left; background-color: #EEEEEE33; } .empty { color: #EEEEEE33; }</style>",o+="</head>",o+="<body><div id='wrapper'><div class='container'><div class='row'>",o+="<h1>Deadswitch 3 Multiplayer Server</h1>",o+="<b>v"+Server.VERSION+"</b><br>Started: "+new Date(serverStartTime).toString();var n=convertMS(Date.now()-serverStartTime);o+="<br>Uptime: "+n.day+"d "+n.hour+"h "+n.minute+"m "+n.seconds+"s";var i=Object.keys(parties).length;o+="<br><br><b>"+i+"</b> part"+(1==i?"y":"ies");var l=getAllLobbies().length;if(o+="<br><b>"+l+"</b> lobb"+(1==l?"y":"ies"),o+="<br><b>"+getLobbiesInProgress().length+"</b> in progress",o+="<br><b>"+t.length+"</b> player"+(1==t.length?"":"s")+" online",t.length>0){o+="<div><table style='width:100%'><tr><th></th><th>Name</th><th>Username</th><th>Level</th><th>Status</th><th>Latency</th><th>Player ID</th><th>Version</th><th>Host</th><th>Steam ID</th></tr>";for(var s=0;s<t.length;s++){let e=t[s],a=e.info,r=e.player,n=getLobbyData(r.currentLobbyId),i=!1,l=!1;n&&(n.state===LobbyState.IN_PROGRESS?i=!0:n.bPrivate&&(l=!0)),o+="<tr><td>"+s+"</td><td>"+r.name+"</td><td>"+(a.username?a.username:"-")+"</td><td>Level "+r.level+(r.prestige>0?" (Prestige "+r.prestige+")":"")+"</td><td>"+(i?"In Game":n?l?"In Custom Lobby":"In Lobby":"Menu")+(r.currentPartyId?" / Party #"+getPartyIndex(r.currentPartyId):"")+"</td><td>"+(r.latency?r.latency+" ms":"-")+"</td><td>"+r.id+"</td><td>"+a.version+"</td><td>"+a.host+"</td><td>"+(r.steamId?r.steamId:"-")+"</td></tr>"}o+="</table></div>"}var y=getAllPublicLobbies();o+="<h3>Public Lobbies ("+y.length+")</h3>",o+="<div><table style='width:100%'><tr><th></th><th>Lobby ID</th><th>Game Mode</th><th>Players</th><th>State</th></tr>";for(s=0;s<y.length;s++){var b=y[s];o+="<tr "+(0==b.players.length?"class='empty'":"")+"><td>"+s+"</td><td>"+b.id+"</td><td>"+b.gameModeId+"</td><td>"+b.players.length+"</td><td>"+b.state+"</td></tr>"}o+="</table></div>";var d=lobbies.private;if(o+="<h3>Custom Lobbies ("+d.length+")</h3>",d.length>0)for(s=0;s<d.length;s++){let e=d[s];s>0&&(o+="<br>"),o+=e.gameModeId+" | "+e.gameData.mapId+" | <b>"+e.state+"</b>";let a=e.players;o+="<div><table style='width:100%'><tr><th></th><th>Name</th><th>Socket ID</th></tr>";for(var c=0;c<a.length;c++){let e=a[c];o+="<tr><td><center>"+c+"</center></td><td>"+e.name+"</td><td>"+e.id+"</td></tr>"}o+="</table></div>"}else o+="<font class='empty'>None</font>";if(o+="<h3>Global Chat</h3>",chatHistory.length>0)for(s=0;s<chatHistory.length;s++){var m=chatHistory[s];o+=m.date+" [<b>"+m.playerText+"</b>] "+m.messageText+"<br>"}else o+="<font class='empty'>None</font><br>";o+="<h3>Cumulative Stats</h3>";var g=Object.keys(stats);for(s=0;s<g.length;s++)o+=g[s]+": "+stats[g[s]]+"<br>";o+="<h3>Memory Usage</h3>";var _=process.memoryUsage();for(g=Object.keys(_),s=0;s<g.length;s++)o+=g[s]+": "+Number(_[g[s]]/1024/1024*100/100).toFixed(4)+"MB<br>";o+="</div></div><body></html>",a.send(o)})),app.get("/data",(function(e,a){var t={version:Server.VERSION,gameVersion:Server.GAME_VERSION,numClients:getNumClients(),maxClients:serverSettings.maxClients,time:Date.now()};serverSettings.welcomeMessage&&(t.welcomeMessage=serverSettings.welcomeMessage),a.setHeader("Access-Control-Allow-Origin","*"),a.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),a.setHeader("Access-Control-Allow-Headers","X-Requested-With,content-type"),a.send(t)}));const LobbyState={INTERMISSION:"intermission",WAITING_HOST:"waiting_host",WAITING:"waiting",PREPARING:"preparing",STARTING:"starting",IN_PROGRESS:"in_progress"},Lobby={WAIT_TIMER:33,INTERMISSION_TIMER:15,COUNTDOWN_PREPARING:15,COUNTDOWN_STARTING:3,COUNTDOWN_STARTING_PRIVATE:3,JOIN_SUCCESS:"LOBBY_JOIN_SUCCESS",JOIN_FAIL_LOCKED:"JOIN_FAIL_LOCKED",JOIN_FAIL_CAPACITY:"JOIN_FAIL_CAPACITY",JOIN_FAIL_ERROR:"JOIN_FAIL_ERROR",MAX_PLAYERS:8},Party={JOIN_SUCCESS:"PARTY_JOIN_SUCCESS",JOIN_FAIL_CAPACITY:"PARTY_JOIN_FAIL_CAPACITY",JOIN_FAIL_LOBBY:"PARTY_JOIN_FAIL_LOBBY",JOIN_FAIL_ERROR:"PARTY_JOIN_FAIL_ERROR",MAX_PLAYERS:8},MatchState={PRE_GAME:"pre_game",IN_PROGRESS:"in_progress",POST_GAME:"post_game",END_RESULT_WIN:"end_result_win",END_RESULT_LOSS:"end_result_loss",END_RESULT_DRAW:"end_result_draw",END_CONDITION_TIME:"end_condition_time",END_CONDITION_SCORE:"end_condition_score",END_CONDITION_DEAD:"end_condition_dead",END_CONDITION_FORFEIT:"end_condition_forfeit"},GameServer={EVENT_BATCH:0,EVENT_GAME_INIT:1,EVENT_GAME_TIMER:2,EVENT_GAME_PRE_TIMER:3,EVENT_GAME_START:4,EVENT_GAME_END:5,EVENT_GAME_UPDATE:6,EVENT_STORE_BUY:7,EVENT_GAME_MONEY_ADD:8,EVENT_GAME_WAVE_START:9,EVENT_GAME_WAVE_COMPLETE:10,EVENT_GAME_PAUSE:11,EVENT_REQUEST_RANKED_CHARACTER:13,EVENT_CREATE_RANKED_CHARACTER:14,EVENT_CREATE_GENERIC_CHARACTER:15,EVENT_CREATE_INFESTOR:16,EVENT_OBJECT_UPDATE:17,EVENT_OBJECT_HIT:18,EVENT_PAWN_DAMAGE:19,EVENT_PAWN_DIE:20,EVENT_PAWN_ACTION:21,EVENT_SET_PLAYER_CONTROLLER_ID:22,EVENT_CREATE_AI_CONTROLLER:23,EVENT_PLAYER_JOIN:24,EVENT_PLAYER_LEAVE:25,EVENT_PLAYER_UPDATE:26,EVENT_PLAYER_RESPAWN:27,EVENT_PLAYER_EARN_KILLSTREAK:28,EVENT_PLAYER_USE_KILLSTREAK:29,EVENT_PLAYER_OPEN_WORLD_MENU:30,EVENT_PLAYER_CLOSE_WORLD_MENU:31,EVENT_PLAYER_SET_WORLD_POSITION:32,EVENT_PLAYER_EXECUTE_KILLSTREAK:33,EVENT_PLAYER_FLAG:34,EVENT_PLAYER_MULTI_KILL:35,EVENT_PLAYER_UPDATE_CONTROLLABLE:36,EVENT_PLAYER_INPUT:37,EVENT_PLAYER_INTERACT:38,EVENT_PLAYER_UPDATE_INVENTORY:39,EVENT_PLAYER_TRIGGER_WEAPON:40,EVENT_PLAYER_TRIGGER_EQUIPMENT:41,EVENT_PLAYER_TRIGGER_MELEE:42,EVENT_KILLSTREAKS_UPDATE:43,EVENT_ANNOUNCER_MESSAGE:44,EVENT_KILLFEED_ADD:45,EVENT_MESSAGE_ADD:46,EVENT_SPAWN_OBJECT:47,EVENT_SPAWN_BULLET:48,EVENT_SPAWN_EXPLOSION:49,EVENT_SPAWN_GRENADE:50,EVENT_SPAWN_PROJECTILE:51,EVENT_SPAWN_ROCKET:52,EVENT_SPAWN_DROPPED_WEAPON:53,EVENT_SPAWN_CRATE:54,EVENT_SPAWN_FLAG:55,EVENT_SPAWN_EQUIPMENT:56,EVENT_SPAWN_HELICOPTER:57,EVENT_SPAWN_TURRET:58,EVENT_SPAWN_REVIVER:59,EVENT_INTERACTABLE_USED:60,EVENT_REMOVE_OBJECT:61,EVENT_SANDBOX:62,EVENT_ROUND_END:63,EVENT_ROUND_START:64,EVENT_BATTLEZONE:65,EVENT_SWITCH_TEAMS:66},GameMode={SANDBOX:"sandbox",BATTLEZONE:"battlezone",DEATHMATCH:"deathmatch",TEAM_DEATHMATCH:"team_deathmatch",DOMINATION:"domination",CAPTURE_THE_FLAG:"capture_the_flag",DEFENDER:"defender",DEMOLITION:"demolition",HEADQUARTERS:"headquarters",GUN_GAME:"gun_game",INFECTED:"infected",SURVIVAL_BASIC:"survival_basic",SURVIVAL_UNDEAD:"survival_undead",SURVIVAL_CHAOS:"survival_chaos",SURVIVAL_STAKEOUT:"survival_stakeout",SURVIVAL_PRO:"survival_pro",RANDOM:"mode_random",OPERATION:"mode_operation",ROTATION_TEAM:"mode_rotation_team",ROTATION_SURVIVAL:"mode_rotation_survival",ROTATION_COMMUNITY:"mode_rotation_community",GROUND_WAR:"mode_ground_war",COMBAT_TRAINING:"mode_combat_training",HARDCORE:"mode_hardcore"},Map={RIVERSIDE:"map_riverside",DOWNTURN:"map_downturn",OUTPOST:"map_outpost",ESTATE:"map_estate",DISTRICT:"map_district",SANDSTORM:"map_sandstorm",OVERGROWN:"map_overgrown",WAREHOUSE:"map_warehouse",FACTORY:"map_factory",AIRPORT:"map_airport",DOWNTURN_EXTENDED:"map_downturn_extended",BATTLESHIP:"map_battleship",RANDOM:"map_random"},Character={TYPE_HAIR_COLOUR:"hairColour",TYPE_HAIR:"hair",TYPE_BEARD:"beard",TYPE_HEAD:"head",TYPE_BODY:"body",TYPE_FACE:"face",TYPE_FACEWEAR:"facewear",TYPE_EYEWEAR:"eyewear",TYPE_VOICE:"voice",VOICE_A:"a",VOICE_B:"b",VOICE_RU:"ru",VOICE_UK:"uk",VOICE_ZOMBIE:"zombie",HAIR_COLOUR_BROWN:"HAIR_COLOUR_BROWN",HAIR_COLOUR_BROWN_LIGHT:"HAIR_COLOUR_BROWN_LIGHT",HAIR_COLOUR_BLACK:"HAIR_COLOUR_BLACK",HAIR_COLOUR_BLONDE:"HAIR_COLOUR_BLONDE",HAIR_COLOUR_GINGER:"HAIR_COLOUR_GINGER",HAIR_COLOUR_GREY:"HAIR_COLOUR_GREY",HAIR_COLOUR_WHITE:"HAIR_COLOUR_WHITE",HAIR_COLOUR_RED:"HAIR_COLOUR_RED",HAIR_COLOUR_BLUE:"HAIR_COLOUR_BLUE",HAIR_COLOUR_GREEN:"HAIR_COLOUR_GREEN",FACE_DEFAULT:"face0000",FACE_ZOMBIE_1:"face0001",FACE_ZOMBIE_2:"face0002",FACE_ZOMBIE_3:"face0003",FACE_ZOMBIE_4:"face0004",FACE_ZOMBIE_FAT:"face0005",FACE_ZOMBIE_EXPLODER:"face0006",FACE_ZOMBIE_SPITTER:"face0007",FACE_ZOMBIE_SPRINTER:"face0008",HAIR_SHORT:"hair0000",HAIR_BALD:"hair0008",HAIR_LONG:"hair0002",HAIR_PONYTAIL:"hair0003",HAIR_UNDERCUT:"hair0006",HAIR_SPIKES:"hair0005",HAIR_BUZZED:"hair0004",HAIR_FLAT:"hair0001",HAIR_STYLED:"hair0007",HAIR_HORSESHOE:"hair0009",HAIR_MOHAWK:"hair0010",BEARD_NONE:"beard0000",BEARD_STUBBLE:"beard0001",BEARD_FULL:"beard0002",BEARD_CIRCLE:"beard0003",BEARD_GOATEE:"beard0004",BEARD_MOUSTACHE:"beard0005",BEARD_SIDEBURNS:"beard0006",EYEWEAR_NONE:"eyewear0000",EYEWEAR_SHADES:"eyewear0001",EYEWEAR_GLASSES:"eyewear0002",EYEWEAR_GOGGLES_YELLOW:"eyewear0003",EYEWEAR_GOGGLES_ORANGE:"eyewear0004",EYEWEAR_GOGGLES_WHITE:"eyewear0005",EYEWEAR_GOGGLES_BLACK:"eyewear0006",FACEWEAR_NONE:"facewear0000",FACEWEAR_MASK:"facewear0001",FACEWEAR_SKULLMASK:"facewear0002",FACEWEAR_GHILLIE:"facewear0003",FACEWEAR_SCARF_OPFOR:"facewear0004",FACEWEAR_BALACLAVA:"facewear0005",FACEWEAR_SCARF_SPETSNAZ:"facewear0006",FACEWEAR_BANDANA:"facewear0007",FACEWEAR_GAS_MASK:"facewear0008",FACEWEAR_BANDANA_GENERIC:"facewear0009",FACEWEAR_GAITER:"facewear0010",HEAD_DELTA_MEDIC_HELMET:"head0064",HEAD_GIGN_MEDIC_HELMET:"head0065",HEAD_GSG9_MEDIC_HELMET:"head0066",HEAD_MEDIC_HELMET:"head0067",HEAD_NONE:"head0000",HEAD_MASK:"head0001",HEAD_GAS_MASK:"head0002",HEAD_RADIO:"head0003",HEAD_USMC_MASK:"head0004",HEAD_USMC_CAP:"head0005",HEAD_USMC_CAP_BACKWARDS:"head0006",HEAD_USMC_SPEC_OPS:"head0007",HEAD_USMC_HELMET:"head0008",HEAD_USMC_HELMET_TACTICAL:"head0009",HEAD_USMC_BOONIE:"head0010",HEAD_USMC_GHILLIE:"head0011",HEAD_GIGN_HELMET:"head0012",HEAD_GIGN_HELMET_2:"head0013",HEAD_GIGN_CAP:"head0014",HEAD_GSG9_HELMET:"head0015",HEAD_GSG9_HELMET_2:"head0016",HEAD_GSG9_HELMET_3:"head0017",HEAD_OPFOR_SCARF:"head0018",HEAD_OPFOR_HELMET:"head0019",HEAD_OPFOR_HELMET_2:"head0020",HEAD_OPFOR_BERET:"head0021",HEAD_OPFOR_SHADES:"head0022",HEAD_OPFOR_COMMANDER:"head0023",HEAD_RUS_MASK:"head0024",HEAD_RUS_HAT:"head0025",HEAD_RUS_SCARF:"head0026",HEAD_RUS_TOQUE:"head0027",HEAD_RUS_BERET:"head0028",HEAD_RUS_CAP:"head0029",HEAD_RUS_RECON:"head0030",HEAD_RUS_HELMET:"head0031",HEAD_MILITIA_RADIO:"head0032",HEAD_MILITIA_BAND:"head0033",HEAD_MILITIA_BANDANA:"head0034",HEAD_MILITIA_CAP:"head0035",HEAD_MILITIA_SNIPER:"head0036",HEAD_JUGGERNAUT_HELMET:"head0037",BODY_VIP:"vip",BODY_HOSTAGE:"hostage",BODY_USMC_STANDARD:"usmc",BODY_USMC_GHILLIE:"usmc_ghillie",BODY_USMC_HEAVY:"usmc_heavy",BODY_USMC_PARA:"usmc_para",BODY_USMC_RECON:"usmc_recon",BODY_GIGN_STANDARD:"gign",BODY_GIGN_HEAVY:"gign_heavy",BODY_GIGN_PARA:"gign_para",BODY_GIGN_RECON:"gign_recon",BODY_GIGN_TACTICAL:"gign_tactical",BODY_GSG9_STANDARD:"gsg9",BODY_GSG9_HEAVY:"gsg9_heavy",BODY_GSG9_PARA:"gsg9_para",BODY_GSG9_RECON:"gsg9_recon",BODY_GSG9_TACTICAL:"gsg9_tactical",BODY_OPFOR_STANDARD:"opfor",BODY_OPFOR_ROCKETIER:"opfor_rocketier",BODY_OPFOR_HEAVY:"opfor_heavy",BODY_OPFOR_PARA:"opfor_para",BODY_OPFOR_RECON:"opfor_recon",BODY_RUS_STANDARD:"rus",BODY_RUS_BARE:"rus_bare",BODY_RUS_HEAVY:"rus_heavy",BODY_RUS_PARA:"rus_para",BODY_RUS_RECON:"rus_recon",BODY_RUS_ROCKETIER:"rus_rocketier",BODY_JUGGERNAUT:"rus_juggernaut",BODY_MILITIA_STANDARD:"militia",BODY_MILITIA_HEAVY:"militia_heavy",BODY_MILITIA_PARA:"militia_para",BODY_MILITIA_RECON:"militia_recon",BODY_MILITIA_TACTICAL:"militia_tactical",BODY_USMC_KEVLAR:"usmc_kevlar",BODY_GIGN_KEVLAR:"gign_kevlar",BODY_GSG9_KEVLAR:"gsg9_kevlar",BODY_OPFOR_KEVLAR:"opfor_kevlar",BODY_RUS_KEVLAR:"rus_kevlar",BODY_MILITIA_KEVLAR:"militia_kevlar",BODY_ZOMBIE:"zombie",BODY_ZOMBIE_2:"zombie_2",BODY_ZOMBIE_3:"zombie_3",BODY_ZOMBIE_FAT:"zombie_fat",BODY_ZOMBIE_EXPLODER:"zombie_exploder",BODY_ZOMBIE_EXPLODER_BOSS:"zombie_exploder_boss",BODY_ZOMBIE_SPITTER:"zombie_spitter",BODY_ZOMBIE_SPITTER_BOSS:"zombie_spitter_boss",BODY_ZOMBIE_SPRINTER:"zombie_sprinter",BODY_ZOMBIE_SPRINTER_BOSS:"zombie_sprinter_boss"};function removePlayerFromLobby(e,a,t){}function removeSocketPlayerFromLobby(e,a){var t=e.player.currentLobbyId;if(t){log(chalk.bgCyan(t),"Remove socket:",tracePlayer(e),"| Reason:",a),e.leave(t),e.emit("leaveLobby",a);var r=getLobbyData(t);if(r){var o=r.minPlayers;retractLobbyMapVote(getSocketPlayerId(e),t);for(var n=r.players,i=n.length-1;i>=0;i--){let a=n[i];if(a.id==getSocketPlayerId(e)){resetPlayer(a),n.splice(i,1);break}}var l=r.game;if(l&&(l.requestEvent({eventId:GameServer.EVENT_PLAYER_LEAVE,reason:a,playerId:getSocketPlayerId(e)}),r.bAddBots)){var s=getBotPlayerForLobby(r);if(s){initPlayerForGameInProgress(s,r.id),r.players.push(s);var y=clone(s);l.addPlayer(y)}}var b=n.length-getNumBotsInLobby(t);if(r.state===LobbyState.IN_PROGRESS){if(b<o)l&&(r.gameData.bSandbox||(log(chalk.bgCyan(t),"Not enough players in game:",b),r.gameData.bSurvival||r.gameData.bOperation?l.requestEvent({eventId:GameServer.EVENT_GAME_END,result:MatchState.END_RESULT_LOSS,condition:MatchState.END_CONDITION_FORFEIT}):l.requestEvent({eventId:GameServer.EVENT_GAME_END,result:MatchState.END_RESULT_WIN,condition:MatchState.END_CONDITION_FORFEIT}))),0==b&&(log("Lobby is empty, reset state"),resetMapVotes(r.id),setLobbyState(r.id,LobbyState.WAITING)),broadcastServerData();else if(o>1&&l&&isTeamGameMode(r.gameModeId)){var d=r.players,c=[0,0];for(i=0;i<d.length;i++){var m=d[i];m.team>=0&&c[m.team]++}0!=c[0]&&0!=c[1]||l.requestEvent({eventId:GameServer.EVENT_GAME_END,result:MatchState.END_RESULT_WIN,condition:MatchState.END_CONDITION_FORFEIT})}}else{checkLobbyReady(t),sendChatMessage(t,{messageText:(e.player?e.player.name:"Player")+("kicked"==a?" was kicked":" left"),locText:"kicked"==a?"STR_X_WAS_KICKED_LOBBY":"STR_X_LEFT_LOBBY",params:[e.player?e.player.name:"Player"]});o=r.gameModeId==GameMode.BATTLEZONE?1:2;if(r.bPrivate&&r.state===LobbyState.STARTING)setLobbyState(t,LobbyState.WAITING_HOST);else if(b<o&&(resetMapVotes(t),0===b||r.state!==LobbyState.INTERMISSION)){var g=r.bPrivate?LobbyState.WAITING_HOST:LobbyState.WAITING;r.state!==g&&setLobbyState(t,g)}io.sockets.in(t).emit("updateLobby",getSafeLobbyData(r))}switch(a){case"kicked":removePlayerFromParty(e),e.emit("showWindow",{titleText:"STR_PLAYER_KICKED",messageText:"STR_PLAYER_KICKED_HOST_DESC",bShowOkayButton:!0});break;case"latency":e.emit("showWindow",{titleText:"STR_PLAYER_KICKED",messageText:"STR_PLAYER_KICKED_LATENCY_DESC",bShowOkayButton:!0});break;case"idle":e.emit("showWindow",{titleText:"STR_PLAYER_KICKED",messageText:"STR_PLAYER_KICKED_IDLE_DESC",bShowOkayButton:!0})}if(r.bPrivate)getSocketPlayerId(e)==r.hostPlayerId&&(log(chalk.yellow("Host has left the lobby!")),e.player.currentPartyId||io.sockets.in(t).emit("showWindow",{titleText:"STR_CUSTOM_LOBBY_DISBANDED",messageText:"STR_HOST_LEFT_DESC",bShowOkayButton:!0}),removeLobby(r.id));else if(0===b){var _=r.rotationId?r.rotationId:r.gameModeId,E=lobbies[_];if(E)E.indexOf(r)>0&&removeLobby(r.id)}}}e&&e.player&&(delete e.player.bLobbyHost,delete e.player.team,delete e.player.currentLobbyId)}function broadcastServerData(){for(var e=getAllPlayers(),a=0;a<e.length;a++){var t=getSocketByPlayerId(e[a].id);t&&t.player&&!t.player.currentLobbyId&&t.emit("updateServerStats",getLatestServerData())}}function initLobbies(){for(var e=[GameMode.COMBAT_TRAINING,GameMode.GROUND_WAR,GameMode.ROTATION_TEAM,GameMode.ROTATION_SURVIVAL,GameMode.HARDCORE],a=0;a<e.length;a++){lobbies[r=e[a]]=[],createRotationLobby(r)}var t=[GameMode.BATTLEZONE,GameMode.DEATHMATCH,GameMode.TEAM_DEATHMATCH,GameMode.DOMINATION,GameMode.CAPTURE_THE_FLAG,GameMode.DEFENDER,GameMode.DEMOLITION,GameMode.HEADQUARTERS,GameMode.GUN_GAME,GameMode.INFECTED,GameMode.SURVIVAL_UNDEAD,GameMode.SURVIVAL_BASIC,GameMode.SURVIVAL_CHAOS,GameMode.SURVIVAL_STAKEOUT,GameMode.SURVIVAL_PRO];for(a=0;a<t.length;a++){var r;lobbies[r=t[a]]=[],createPublicLobby(r)}lobbies.private=[]}function createRotationLobby(e){log("Create rotation lobby:",chalk.cyan(e));var a=!0,t=!1,r=2,o=shared.maxPlayers[e];switch(e){case GameMode.ROTATION_SURVIVAL:r=1,a=!1,t=!0;break;case GameMode.GROUND_WAR:case GameMode.COMBAT_TRAINING:var n=!0;r=1;break;case GameMode.HARDCORE:var i=!0;r=2;break;default:r=2}var l=getRandomUniqueId(),s=shared.rotations[e],y=getRandomLobbyMaps(e,s),b=y[0].gameModeId,d=getDefaultGameModeSettings(b),c={id:l,rotationId:e,rotationModes:s,gameModeId:b,gameData:{lobbyId:l,bMultiplayer:!0,gameModeId:b,mapId:Map.RIVERSIDE,settings:d,maxPlayers:o,bRanked:a,bSurvival:t},minPlayers:r,maxPlayers:o,players:[],maps:y,state:LobbyState.WAITING,timer:-1,bLocked:!1,bAddBots:n,bHardcore:i};return lobbies[e].push(c),c}function createPublicLobby(e){log("Create public lobby:",chalk.cyan(e));var a=!0,t=!1,r=2,o=shared.maxPlayers[e];switch(e){case GameMode.SURVIVAL_BASIC:case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_UNDEAD:case GameMode.SURVIVAL_STAKEOUT:case GameMode.SURVIVAL_PRO:r=2,a=!1,t=!0;break;case GameMode.GUN_GAME:case GameMode.DEATHMATCH:r=2;break;case GameMode.BATTLEZONE:r=1;break;default:r=2}var n=getRandomUniqueId(),i=getRandomLobbyMaps(e),l=getDefaultGameModeSettings(e),s={id:n,gameModeId:e,gameData:{lobbyId:n,bMultiplayer:!0,gameModeId:e,mapId:Map.RIVERSIDE,settings:l,maxPlayers:o,bRanked:a,bSurvival:t},minPlayers:r,maxPlayers:o,players:[],maps:i,state:LobbyState.WAITING,timer:-1,bLocked:!1};return lobbies[e].push(s),s}function getRandomLobbyMaps(e,a){var t=!0;switch(e){case GameMode.BATTLEZONE:var r=[Map.DOWNTURN,Map.SANDSTORM,Map.OVERGROWN,Map.AIRPORT,Map.DOWNTURN_EXTENDED];shuffleArray(r),r.splice(0,1),t=!1;break;default:r=[Map.RIVERSIDE,Map.DISTRICT,Map.WAREHOUSE,Map.OUTPOST,Map.ESTATE,Map.FACTORY,Map.DOWNTURN,Map.SANDSTORM,Map.OVERGROWN,Map.AIRPORT]}shuffleArray(r),a&&shuffleArray(a);for(var o=[],n=0;n<(t?2:r.length);n++)o.push({id:r[n],votes:[],gameModeId:a?a[n]:null});return t&&o.push({id:Map.RANDOM,votes:[],gameModeId:a?a[n]:null}),o}function getNumRealPlayersInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r=a.players,o=0;o<r.length;o++){var n=r[o];n.bBot&&!n.bDummy||t++}return t}return 0}function getNumRealTeamPlayersInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r={},o=a.players,n=0;n<o.length;n++){var i=o[n];i.bBot&&!i.bDummy||(i.currentPartyId?(r[i.currentPartyId]||t++,r[i.currentPartyId]=!0):t++)}return t}return 0}function removeBotsFromLobby(e){var a=getLobbyData(e);if(a){for(var t=a.players,r=0,o=t.length-1;o>=0;o--){var n=t[o];n.bBot&&!n.bDummy&&(t.splice(o,1),r++)}r>0&&log("Removed",r,"bots from",chalk.bgCyan(e))}}function getNumBotsInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r=a.players,o=0;o<r.length;o++){var n=r[o];n.bBot&&!n.bDummy&&t++}return t}return 0}function getNumDummiesInLobby(e){var a=getLobbyData(e);if(a){for(var t=0,r=a.players,o=0;o<r.length;o++){r[o].bDummy&&t++}return t}return 0}function removeLobby(e){log("Removing lobby: "+chalk.bgCyan(e));var a=getLobbyData(e);if(a){if(a.bPendingDestroy)return void log("Lobby is already destroyed");for(var t=clone(a.players),r=t.length-1;r>=0;r--){let a=t[r];if(a){var o=getSocketByPlayerId(a.id);o&&removeSocketPlayerFromLobby(o,"lobby_removed")}else console.warn(r,e,"Invalid player in lobby:",a)}if(destroyLobbyGame(a),a.bPrivate){(n=lobbies.private.indexOf(a))>=0&&lobbies.private.splice(n,1)}else{var n,i=a.rotationId?a.rotationId:a.gameModeId;if(i)(n=lobbies[i].indexOf(a))>=0&&lobbies[i].splice(n,1)}var l=Object.keys(a);for(r=0;r<l.length;r++)delete a[l[r]];a.bPendingDestroy=!0,broadcastServerData()}}function createPrivateLobby(e){if(log("Create private lobby: "+chalk.bgCyan(e)),getLobbyData(e))log("Lobby already exists!");else{var a=GameMode.DEATHMATCH,t=getDefaultGameModeSettings(a);t.bots=0,t.botSkill=-1,t.bPrivate=!0;var r={id:e,bPrivate:!0,gameModeId:a,gameData:{lobbyId:e,gameModeId:a,bMultiplayer:!0,bRanked:!0,mapId:Map.RANDOM,settings:t},maxPlayers:Lobby.MAX_PLAYERS,players:[],state:LobbyState.WAITING_HOST,timer:-1,bLocked:!1};lobbies.private.push(r),broadcastServerData()}}function getDefaultGameModeSettings(e){var a=shared.defaultGameSettings[e];return a?clone(a):(console.warn("Missing default settings:",e),{bKillstreaks:!0,bAllowRespawns:!0,bSpawnProtection:!0,timeLimit:10,respawnTime:5})}function createParty(e){if(log("Creating party..."),e.player)if(e.player.currentLobbyId)removeSocketPlayerFromLobby(e,"create_party");else{var a="P-"+String(e.id).substr(0,6);if(getParty(a))return log(chalk.yellow("Party already exists!")),void updatePartyClients(a);addParty(a)&&(joinParty(a,e),sendChatMessage(null,{bServer:!0,messageText:e.player.name+" created a new party."}))}}function addParty(e){if(!getParty(e)){log("Create party: "+chalk.bgCyan(e));var a={id:e,hostPlayerId:null,players:[]};return parties[e]=a,a}return log("Party already exists: "+e),null}function updatePartyClients(e){var a=getParty(e);if(a)for(var t=0;t<a.players.length;t++){var r=getSocketByPlayerId(a.players[t].id);r&&r.emit("updateParty",a)}}function removePlayerFromParty(e){if(e.player&&e.player.currentPartyId){log(chalk.bgCyan(e.player.currentPartyId),"Remove from party --\x3e",tracePlayer(e));var a=getParty(e.player.currentPartyId);if(a){for(var t=0;t<a.players.length;t++)if(a.players[t].id==getSocketPlayerId(e)){a.players.splice(t,1);break}a.players.length>0&&updatePartyClients(a.id),getSocketPlayerId(e)==a.hostPlayerId&&removeParty(a.id)}e.emit("leaveParty"),e.player&&(delete e.player.bPartyHost,delete e.player.currentPartyId)}}function removeParty(e){log("Remove party:",chalk.bgCyan(e));var a=parties[e];if(a)for(var t=a.players,r=t.length-1;r>=0;r--){var o=getSocketByPlayerId(t[r].id);o&&removePlayerFromParty(o)}delete parties[e]}function getParty(e){return e?parties[e]:null}function getNumPlayersInParty(e){var a=getParty(e);return a?a.players.length:1}function getAveragePlayerLevel(e){if(!e)return 1;for(var a=0,t=0;t<e.length;t++){var r=e[t];r.prestige>=1?a+=50:a+=r.level}return Math.round(a/e.length)}function getSafeLobbyDataById(e){return getSafeLobbyData(getLobbyData(e))}function getSafeLobbyData(e){var a=e,t=null;if(a){t={};for(var r=Object.keys(a),o=0;o<r.length;o++){let e=r[o];switch(e){case"game":break;default:t[e]=a[e]}}}return t}function getLobbyData(e){if(!e)return null;for(var a=getAllLobbies(),t=0;t<a.length;t++)if(a[t].id===e)return a[t];return null}function getLobbyPlayerById(e,a){var t=getLobbyData(e);if(t)for(var r=t.players,o=0;o<r.length;o++){var n=r[o];if(n.id===a)return n}return null}function getPartyPlayerById(e,a){var t=getParty(e);if(t)for(var r=t.players,o=0;o<r.length;o++){var n=r[o];if(n.id===a)return n}return null}function getGame(e){var a=getLobbyData(e);return a?a.game:null}function joinParty(e,a){var t=getParty(e);if(t){if(0==t.players.length)t.hostPlayerId=getSocketPlayerId(a),a.player.bPartyHost=!0,log(chalk.bgCyan(e),"Set host --\x3e",tracePlayer(a));else if(t.players.indexOf(a.player)>=0)return;a.player.currentPartyId=e,t.players.push(a.player),log("Party size:",t.players.length),updatePartyClients(e)}}function joinLobby(e,a){var t=getLobbyData(e);if(t){if(a.player.currentLobbyId)return void console.log(e,tracePlayer(a),"already in lobby:",a.player.currentLobbyId);a.player.currentLobbyId=e,log(tracePlayer(a),"Joined lobby",chalk.bgCyan(e)),a.join(e),a.info.autoJoinAttempts=0;var r=a.player,o=t.players,n=" (2)",i=r.name.indexOf(n);i>=0&&(r.name=r.name.substring(0,i));for(var l=0;l<o.length;l++)o[l].name===r.name&&(r.name+=n);o.push(r),t.bPrivate&&(1===o.length?(t.hostPlayerId=a.player.id,r.bLobbyHost=!0,r.desiredTeam=0):r.desiredTeam=o.length%2==0?1:0),t.game?joinGameInProgress(t,a):(a.emit("joinLobby",getSafeLobbyData(t)),io.sockets.in(e).emit("updateLobby",getSafeLobbyData(t)),sendChatMessage(e,{messageText:r.name+" joined",clan:r.clan,locText:"STR_X_JOINED_LOBBY",params:[r.name]}),checkLobbyReady(e))}else console.warn("joinLobby --\x3e Invalid lobby data:",e)}function joinGameInProgress(e,a){var t=e;log("Joining game in progress"),a.emit("joinLobby",{id:t.id,gameModeId:e.gameModeId,rotationId:e.rotationId,bInProgress:!0,bPrivate:t.bPrivate,players:t.players}),initPlayerForGameInProgress(a.player,t.id);var r=t.gameData,o={bInProgress:!0,bPrivate:t.bPrivate,settings:r.settings,gameModeId:r.gameModeId,mapId:r.mapId,players:t.players,bMultiplayer:!0,bRanked:r.bRanked,bSurvival:r.bSurvival};onSocketStartGame(a.id,o)}function onSocketStartGame(e,a){var t=getSocketById(e);t&&(t.player?(t.emit("startGame",a),setTimeout((()=>{onSocketEnterGame(e)}),3e3)):(console.warn("Invalid socket player data"),t.disconnect()))}function onSocketEnterGame(e){var a=getSocketById(e);a&&(a.player?(a.player.bReady=!0,a.emit("enterGame")):(console.warn("Invalid socket player data"),a.disconnect()))}function getAvailableLobbyIndexForGameMode(e,a=1){var t=lobbies[e];if(t)for(var r=t.slice().sort((function(e,a){return e.players.length>a.players.length?-1:e.players.length<a.players.length?1:0})),o=0;o<r.length;o++){var n=r[o],i=!n.bLocked||lobbyCanAcceptPlayers(n.id),l=getNumBotsInLobby(n.id);if(i&&n.players.length+a-l<=n.maxPlayers&&!n.bMerging)return t.indexOf(n)}return-1}function genIdFromSocket(e){return e.id.substr(2,6)}function tracePlayer(e){return e?chalk.bgMagenta(getSocketPlayerId(e))+(e.player?" ["+chalk.yellow(e.player.name)+chalk.green(e.info.username?"@"+e.info.username:"")+"]":""):null}function onLobbyAboutToStart(e){e&&!e.bPrivate&&(e.players.length<e.maxPlayers&&Object.keys(io.sockets.connected).forEach((function(a){var t=io.sockets.connected[a];t&&t.player&&!t.player.currentLobbyId&&t.emit("serverMessage",{type:"game_starting",lobbyId:e.id,rotationId:e.rotationId,gameModeId:e.gameModeId,id:e.id})})))}function mergeLobbies(e,a){if(e&&a){if(log("Merging lobbies:",chalk.bgCyan(e.id),"--\x3e",chalk.bgCyan(a.id)),e.bPrivate||a.bPrivate)return log("A lobby is private"),!1;if(e.bLocked||a.bLocked)return log("A lobby is locked"),!1;if(e.bMerging||a.bMerging)return log("A lobby is being merged"),!1;if(e.bPendingDestroy||a.bPendingDestroy)return log("A lobby is destroyed"),!1;var t=e.players.length+a.players.length;if(log("Combined players:",t),t<2)return log("Not enough players to merge"),!1;if(t>e.maxPlayers)return log("Not enough room to merge",t+"/"+e.maxPlayers),!1;var r=getLobbyData(e.id),o=r?r.id:null,n=clone(a.players);if(o&&n){r.bMerging=!0;for(var i=n.length,l=i-1;l>=0;l--){var s=n[l],y=s?getSocketByPlayerId(s.id):null;if(y){switch(canJoinLobby(o,y)){case Lobby.JOIN_SUCCESS:removeSocketPlayerFromLobby(y,"merge"),joinLobby(o,y)}}else{var b=n.indexOf(s);b>=0&&n.splice(b,1)}}return log("Merged",i,"player"+(1==i?"":"s")+" into",chalk.bgCyan(o)),delete r.bMerging,!0}return console.warn("mergeLobbies --\x3e Invalid lobby players:",a),!1}return console.warn("Invalid lobby data while trying to merge:",e,a),!1}function joinLobbyById(e,a){if(e){log(tracePlayer(e),"Wants to join lobby by id",chalk.bgCyan(a));var t=getLobbyData(a);if(t){if(t.bPrivate&&t.gameData.settings.bPrivate)return;switch(canJoinLobby(a,e)){case Lobby.JOIN_SUCCESS:var r=getParty(e.player.currentPartyId);if(r)for(i=0;i<r.players.length;i++){var o=getSocketByPlayerId(r.players[i].id);canJoinLobby(a,o)==Lobby.JOIN_SUCCESS&&joinLobby(a,o)}else joinLobby(a,e)}}}}function getPlayerValue(e){return e?e.level*(e.prestige+1):1}function joinLobbyByGameModeId(e,a,t){if(e.player&&(a?log(tracePlayer(e),"Wants to join game mode",chalk.bgCyan(a)):log(tracePlayer(e),"Auto join..."),validateClient(e)))if(e.player.currentLobbyId)a&&removeSocketPlayerFromLobby(e,"joining_different_lobby");else{var r=e.player.currentPartyId;if(r)if((c=getParty(r))&&getSocketPlayerId(e)!==c.hostPlayerId)return;if(!a){var o=getAllPublicLobbies();if(e.info.autoJoinAttempts++,e.info.autoJoinAttempts>=60){log(tracePlayer(e),"Joining random lobby..."),shuffleArray(o);for(var n=0;n<o.length;n++){if(((i=o[n]).gameModeId!=GameMode.BATTLEZONE||t)&&((i.rotationId!=GameMode.COMBAT_TRAINING||e.player.level<=25&&0==e.player.prestige)&&canJoinLobby(i.id,e)==Lobby.JOIN_SUCCESS)){a=i.rotationId?i.rotationId:i.gameModeId;break}}}else{o.sort((function(a,t){var r=getPlayerValue(e.player),o=getAveragePlayerLevel(a.players)-r,n=getAveragePlayerLevel(t.players)-r;return o>n?1:o<n||a.players.length>t.players.length?-1:a.players.length<t.players.length?1:0}));for(n=0;n<o.length;n++){var i;if(((i=o[n]).gameModeId!=GameMode.BATTLEZONE||t)&&((i.rotationId!=GameMode.COMBAT_TRAINING||e.player.level<=25&&0==e.player.prestige)&&i.players.length>0&&canJoinLobby(i.id,e)===Lobby.JOIN_SUCCESS)){a=i.rotationId?i.rotationId:i.gameModeId;break}}}}if(lobbies[a]){var l=getAvailableLobbyIndexForGameMode(a,getNumPlayersInParty(e.player.currentPartyId));if(-1==l){var s=lobbies[a];if(s&&s.length<serverSettings.maxPublicLobbies){if(isRotationGameMode(a))var y=createRotationLobby(a);else y=createPublicLobby(a);y&&(l=s.length-1,broadcastServerData())}}if(l>=0){var b=lobbies[a][l];if(b){var d=b.id;if(lobbies[a].length>0)switch(canJoinLobby(d,e)){case Lobby.JOIN_SUCCESS:var c;if(c=getParty(e.player.currentPartyId))for(n=0;n<c.players.length;n++){var m=getSocketByPlayerId(c.players[n].id);canJoinLobby(d,m)==Lobby.JOIN_SUCCESS&&joinLobby(d,m)}else joinLobby(d,e)}}}}}}function lobbyCanAcceptPlayers(e,a=1){if(!serverSettings.bAllowJoinInProgress)return!1;var t=getLobbyData(e);if(t){if(t.state==LobbyState.STARTING)return!1;var r=getNumBotsInLobby(t.id);if(t.players.length-r+a>t.maxPlayers)return!1;if(t.bPrivate&&t.gameData&&t.gameData.settings.bPrivate)return!1;var o=t.game;return!!o&&o.canAcceptNewPlayers()}return!1}function canJoinLobby(e,a){var t=getLobbyData(e);if(t){if(!a.player)return Lobby.JOIN_FAIL_ERROR;var r=getNumBotsInLobby(t.id),o=getNumPlayersInParty(a.player.currentPartyId);return t.players.length-r+o>t.maxPlayers?Lobby.JOIN_FAIL_CAPACITY:t.bLocked?lobbyCanAcceptPlayers(e,o)||a.player.bAdmin?Lobby.JOIN_SUCCESS:Lobby.JOIN_FAIL_LOCKED:Lobby.JOIN_SUCCESS}return Lobby.JOIN_FAIL_ERROR}function canJoinParty(e,a){var t=getParty(e);if(t){if(t.players.length+1>Party.MAX_PLAYERS)return Party.JOIN_FAIL_CAPACITY;var r=getSocketByPlayerId(t.hostPlayerId);if(r&&r.player.currentLobbyId){var o=canJoinLobby(r.player.currentLobbyId,a);switch(o){case Lobby.JOIN_SUCCESS:break;default:return o}}return Party.JOIN_SUCCESS}return Party.JOIN_FAIL_ERROR}function checkLobbyReady(e){if(e){var a=getLobbyData(e);if(a){if(a.bPrivate)return;if(a.state===LobbyState.INTERMISSION&&a.players.length>0)return;if(log(chalk.bgCyan(e),"Checking if lobby is ready to start..."),a.state===LobbyState.IN_PROGRESS)0===a.players.length&&(setLobbyState(e,a.bPrivate?LobbyState.WAITING_HOST:LobbyState.WAITING),stopLobbyInterval(e));else if(!a.bLocked){tryMerge(a);var t=a.minPlayers>=2?2:1;if(getNumRealPlayersInLobby(e)>=a.minPlayers&&getNumRealTeamPlayersInLobby(e)>=t||a.players.length==a.maxPlayers){var r=a.state;setLobbyState(e,LobbyState.PREPARING),intervals[e]||(r==LobbyState.PREPARING&&a.timer||(a.timer=Lobby.COUNTDOWN_PREPARING),stopLobbyInterval(e),intervals[e]=setInterval(onLobbyTimer,1e3,e)),onLobbyAboutToStart(a)}else setLobbyState(e,LobbyState.WAITING),stopLobbyInterval(e);io.sockets.in(e).emit("updateLobby",getSafeLobbyData(a))}}}}function tryMerge(e){if(e){var a=lobbies[e.rotationId?e.rotationId:e.gameModeId];if(a&&a.length>=2)for(var t=0;t<a.length;t++){var r=a[t];r&&r.id!=e.id&&mergeLobbies(e,r)}}}function sendChatMessageToSocket(e,a){if(a){var t=getSocketById(e);t&&t.emit("receiveLobbyChatMessage",a)}}function votekickPlayer(e,a,t){log("Votekick",t);var r=getLobbyPlayerById(e,t);if(r){r.bBot;var o=getLobbyData(e);if(o){var n=o.votekick;n||(n={}),n[t]||(n[t]={players:[]});var i=n[t];if(i.players.indexOf(a)>=0)return;i.players.push(a);var l=i.players.length,s=Math.ceil(.5*o.players.length);if(log(l,"/",s,"votes"),sendChatMessage(o.id,{bServer:!0,messageText:l+"/"+s+" votes needed to kick "+r.name}),l>=s){log("Kick player");var y=getSocketByPlayerId(t);y?removeSocketPlayerFromLobby(y,"kicked"):console.warn("Invalid socket for votekick")}}}}function sendChatMessage(e,a){if(a)if(a.date=(new Date).toISOString(),e)io.sockets.in(e).emit("receiveLobbyChatMessage",a);else{chatHistory.push(a),chatHistory.length>10&&chatHistory.splice(0,1);for(var t=getAllPlayers(),r=0;r<t.length;r++){var o=getSocketByPlayerId(t[r].id);o&&o.player&&!o.player.currentLobbyId&&o.emit("receiveLobbyChatMessage",a)}}}function onPlayerWaitTimer(e){var a=getLobbyData(e);if(a)if(a.state===LobbyState.IN_PROGRESS){if(a.waitTimer>0)io.sockets.in(e).emit("updateWaitTimer",{timer:a.waitTimer}),a.waitTimer--;else if(0===a.waitTimer){var t=a.players;if(t.length>0)for(var r=t.length-1;r>=0;r--){var o=t[r];if(o||console.warn("Invalid player",r,t),o&&!o.bReady){var n=getSocketByPlayerId(o.id);n&&(log(tracePlayer(n),"is idle"),disconnectSocket(n,{reason:"idle"}))}}if(stopLobbyInterval(e,"waitTimer"),console.log("Players after kicking:",t.length),t.length>1){var i=a.gameData;i?(i.players=clone(t),onInitGame(e,i)):console.warn("No gameData",a.gameData)}else log("Not enough players, end game!"),endLobbyGame(e,!1)}}else stopLobbyInterval(e,"waitTimer")}function onLobbyTimer(e){var a=getLobbyData(e);if(a){var t=a.timer;a.timer--,t<=0&&(stopLobbyInterval(e),delete a.timer,onLobbyTimerComplete(e)),io.sockets.in(e).emit("updateLobby",{state:a.state,timer:a.timer})}}function onLobbyTimerComplete(e){var a=getLobbyData(e);if(a)switch(a.state){case LobbyState.INTERMISSION:setLobbyState(e,LobbyState.WAITING),checkLobbyReady(e);break;case LobbyState.PREPARING:setLobbyState(e,LobbyState.STARTING),a.timer=Lobby.COUNTDOWN_STARTING,stopLobbyInterval(e),intervals[e]=setInterval(onLobbyTimer,1e3,e),io.sockets.in(e).emit("updateLobby",{state:a.state,timer:a.timer,players:a.players});break;case LobbyState.STARTING:setLobbyState(e,LobbyState.IN_PROGRESS);var t=a.gameData.operationId;if(t){var r=a.gameData.settings.difficulty,o=a.gameData.settings.bPrivate,n=a.gameData.settings.bDebug;log("Start operation:",chalk.yellow(t),"difficulty:",r,a.gameData.settings.bPrivate);var i=operationData[t];if(i)a.gameData=clone(i.gameData),a.gameData.settings.difficulty=r,a.gameData.settings.bPrivate=o,a.gameData.settings.bDebug=n,a.gameData.operation=clone(i),a.gameData.lobbyId=e,a.gameData.bMultiplayer=!0,a.gameData.bRanked=!0;else var l=!0,s="Invalid Operation data"}if(l)console.warn("An error occurred while starting match",s),endLobbyGame(e,!1),showWindowForSockets(getLobbyPlayerIds(a),{titleText:"STR_ERROR",messageText:"STR_ERROR_DESC",error:s,bShowOkayButton:!1,type:"TYPE_ERROR"});else{for(var y=[],b=0;b<a.players.length;b++)y.push(clone(a.players[b]));a.gameData.players=y,a.gameData.data={shared:shared,sprites:sprites,atlas_weapons_world:atlas_weapons_world,weapons:weapons,mods:mods,perks:perks,killstreaks:killstreaks,modes:game_modes,maps:allMaps,graph:ngraphGraph,path:ngraphPath},io.sockets.in(e).emit("startGame",a.gameData),stopLobbyInterval(e),intervals[e]=setInterval(onEnterGame,3e3,e)}}}function onEnterGame(e){stopLobbyInterval(e),io.sockets.in(e).emit("enterGame"),broadcastServerData()}function onInitGame(e,a){log(chalk.bgCyan(e),"Initialize game"),stats.gamesPlayed++,stats.peakGamesInProgress=Math.max(stats.peakGamesInProgress,getLobbiesInProgress().length);var t=getLobbyData(e);if(t){stopLobbyInterval(t.id),stopLobbyInterval(t.id,"waitTimer"),delete t.waitTimer,destroyLobbyGame(t);var r=new gameInstance.GameInstance;r.bInit?(console.warn("Game is already initialized"),r.destroy()):(a.players=clone(t.players),r.init(a,(e=>{if(e){var a=t.id;if(a){var r=io.sockets.adapter.rooms[a];if(r)for(var o=r.sockets,n=Object.keys(o),i=0;i<n.length;i++){let a=getSocketById(n[i]);a&&a.player&&(a.emit("gameEvent",e),stats.emits++)}}else console.warn("onGameInstanceEvent --\x3e Invalid lobby id",a)}}),p2),r.setEndCallback(onEndGame),t.game=r)}else log("Invalid lobby data!")}function onEndGame(e){stopLobbyTimeout(e),log(chalk.bgCyan(e),"Starting end game timer...");var a=setTimeout(onEndGameTimeout,15e3,e,!0);lobbyTimers[e]=a;var t=getLobbyData(e);if(!t.bPrivate&&t.gameData.bRanked)for(var r={},o=t.game.getWinner(),n=0;n<t.players.length;n++){var i=t.players[n];if(i.clan&&!i.bBot){var l=t.game.getPlayerStateById(i.id);if(l){var s=0;l.team==o&&(r[i.clan]||(r[i.clan]=!0,s++));for(var y=["score","captures","returns","plants","defuses"],b=0;b<y.length;b++){let e=y[b];if(l[e]>0){let a=l[e];"score"==e&&(a=Math.ceil(.05*a)),s+=a}}async_updateClanScore(i.clan,s,l.kills)}}}}function stopLobbyTimeout(e){var a=lobbyTimers[e];a&&(log(chalk.bgCyan(e),"Clearing lobby timer..."),clearTimeout(a),delete lobbyTimers[e])}function onEndGameTimeout(e){endLobbyGame(e,!0)}function endLobbyGame(e,a){log(chalk.bgCyan(e),"End lobby game");var t=getLobbyData(e);t?(t.bPrivate?setLobbyState(e,LobbyState.WAITING_HOST):setLobbyState(e,a?LobbyState.INTERMISSION:LobbyState.WAITING),io.sockets.in(e).emit("updateLobby",getSafeLobbyData(t)),broadcastServerData()):log("Lobby doesn't exist:",e)}function getNumPlayersOnTeam(e,a){var t=0;if(e)for(var r=e.players,o=0;o<r.length;o++)r[o].team==a&&t++;return t}function getTeamValue(e,a){for(var t=0,r=0;r<e.length;r++){var o=e[r];o.team===a&&(t+=o.level+50*o.prestige)}return t}function setLobbyTeams(e){if(e){var a=e.gameModeId,t=isTeamGameMode(a),r=e.gameData.settings,o=e.players;if(o){var n=r.factions;if(!e.bPrivate&&t){if(e.rotationId==GameMode.COMBAT_TRAINING&&getNumRealPlayersInLobby(e.id)<.5*e.maxPlayers)for(var i=MathUtil.RandomBoolean()?0:1,l=0;l<o.length;l++){let a=o[l];a.bBot?getNumPlayersOnTeam(e,0)>getNumPlayersOnTeam(e,1)?a.team=1:a.team=0:a.team=i}else{o.sort(((e,a)=>e.currentPartyId?a.currentPartyId?e.currentPartyId<a.currentPartyId?-1:e.currentPartyId>a.currentPartyId?1:0:-1:1));var s=[],y=[],b=[];for(l=0;l<o.length;l++){(m=o[l]).currentPartyId&&getNumPlayersInParty(m.currentPartyId)>1?(-1==s.indexOf(m.currentPartyId)&&s.push(m.currentPartyId),m.team=s.indexOf(m.currentPartyId)%2==0?0:1,y.push(m)):b.push(m)}b.sort(((e,a)=>e.prestige<a.prestige?1:e.prestige>a.prestige?-1:e.level<a.level?1:e.level>a.level?-1:0));for(l=0;l<b.length;l++)getNumPlayersOnTeam(e,0)>getNumPlayersOnTeam(e,1)?b[l].team=1:b[l].team=0;o=y.concat(b)}o.sort(((e,a)=>e.team<a.team?-1:e.team>a.team?1:0)),e.players=o}var d=!1,c=e.bPrivate&&t;for(l=0;l<o.length;l++){var m=o[l];switch(a){case GameMode.BATTLEZONE:getNumPlayersInParty(m.currentPartyId)>1?m.team=o.length+getPartyIndex(m.currentPartyId):m.team=l,d=!0;break;case GameMode.GUN_GAME:case GameMode.DEATHMATCH:m.team=l,d=!0;break;case GameMode.INFECTED:case GameMode.SURVIVAL_BASIC:case GameMode.SURVIVAL_UNDEAD:case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_STAKEOUT:case GameMode.SURVIVAL_PRO:case GameMode.OPERATION:case GameMode.SANDBOX:m.team=0,d=!0;break;default:c?void 0!==m.desiredTeam?m.team=m.desiredTeam:m.bBot&&r.botTeam>=0?m.team=r.botTeam:m.team=getBestTeam(o):null==m.team&&(m.team=MathUtil.Random(0,1)),d=!1}var g=n?n[m.team]:null;g&&!d||(g=m.avatars.preferred),m.avatarData=m.avatars[g],d&&(m.avatarData.preferred=m.avatars.preferred)}o.sort((function(e,a){return e.team<a.team?-1:e.team>a.team?1:0}))}}else log("Invalid lobby data!")}function initPlayerForGameInProgress(e,a){var t=e;if(t){var r=getLobbyData(a);if(r){log("Initializing player for game...");var o=r.players,n=r.gameData.settings.factions,i=!1;switch(r.gameModeId){case GameMode.BATTLEZONE:for(var l=[],s=0;s<r.maxPlayers;s++)l.push(s);if(t.currentPartyId&&getNumPlayersInParty(t.currentPartyId)>1)t.team=r.maxPlayers+getPartyIndex(t.currentPartyId);else{for(s=0;s<o.length;s++){let e=o[s].team;null!=e&&l.splice(l.indexOf(e),1)}t.team=l[0]}i=!0;break;case GameMode.GUN_GAME:case GameMode.DEATHMATCH:for(l=[],s=0;s<r.maxPlayers;s++)l.push(s);for(s=0;s<o.length;s++){let e=o[s].team;null!=e&&l.splice(l.indexOf(e),1)}t.team=l[0],i=!0;break;case GameMode.SURVIVAL_BASIC:case GameMode.SURVIVAL_UNDEAD:case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_STAKEOUT:case GameMode.SURVIVAL_PRO:case GameMode.OPERATION:t.team=0,i=!0;break;case GameMode.INFECTED:t.team=1,i=!0;break;default:var y=[0,0],b=null;for(s=0;s<o.length-1;s++){let e=o[s];null!=e.team&&y[e.team]++,t.currentPartyId&&e.currentPartyId===t.currentPartyId&&(b=e.team)}if(null!=b)t.team=b;else if(y[0]>y[1])t.team=1;else if(y[0]<y[1])t.team=0;else{var d=r.game;t.team=d?d.getNewPlayerDesiredTeam():MathUtil.Random(0,1)}}var c=n?n[t.team]:null;c&&!i||(c=t.avatars.preferred),t.avatarData=t.avatars?t.avatars[c]:null,t.avatarData?i&&(t.avatarData.preferred=t.avatars.preferred):console.warn("Invalid avatar data",t)}}}function getBestTeam(e){if(e){for(var a=[{team:0,num:0},{team:1,num:0}],t=0;t<e.length;t++){var r=e[t];if(void 0!==r.team)a[r.team].num++}return a.sort((function(e,a){return e.num-a.num})),a[0].team}return 0}function verifyPrivateLobbyTeams(e){if(e){var a=e.gameData.settings;if(a.bDebug)return!0;var t=e.players;if(isTeamGameMode(e.gameModeId)&&0===a.bots){for(var r=[!1,!1],o=0;o<t.length;o++){if(void 0!==(i=t[o]).desiredTeam&&(r[i.desiredTeam]=!0,r[0]&&r[1]))return!0}return!1}if(!(a.botTeam>=0))return!0;var n=1===a.botTeam?0:1;for(o=0;o<t.length;o++){var i;if(void 0===(i=t[o]).desiredTeam||i.desiredTeam===n)return!0}}return!1}function resetPlayers(e){if(e){for(var a=0;a<e.length;a++)resetPlayer(e[a]);e.sort((function(e,a){return e.bLobbyHost?-1:a.bLobbyHost?1:e.bPartyHost?-1:a.bPartyHost?1:0}))}}function resetPlayer(e){delete e.team,delete e.bReady,delete e.bInGame}function destroyLobbyGame(e){if(e){var a=e.game;a&&(a.destroy(),delete e.game)}}function setLobbyState(e,a){log(chalk.bgCyan(e),"--\x3e",chalk.inverse(a));var t=getLobbyData(e);if(t)switch(destroyLobbyGame(t),stopLobbyInterval(e),stopLobbyTimeout(e),t.state=a,t.state){case LobbyState.WAITING:removeBotsFromLobby(e),t.bLocked=!1,t.timer=-1,resetPlayers(t.players);break;case LobbyState.WAITING_HOST:removeBotsFromLobby(e),t.bLocked=!1,t.timer=-1,resetPlayers(t.players);var r=t.gameData;if(r.operation){log(chalk.bgCyan(e),"Resetting operation data"),t.gameModeId=GameMode.OPERATION,r.gameModeId=GameMode.OPERATION,r.operationId=r.operation.id;var o=r.settings.bDebug,n=r.settings.difficulty,i=r.settings.bPrivate;r.settings=getDefaultGameModeSettings(GameMode.OPERATION),r.settings.bDebug=o,r.settings.bPrivate=null==i||i,r.settings.difficulty=n,delete r.operation}break;case LobbyState.PREPARING:t.bLocked=!1;break;case LobbyState.STARTING:t.bLocked=!0;var l=t.maps;if(l){for(var s=0,y=0,b=0;b<l.length;b++){var d=l[b].votes.length;d>y&&(s=b,y=d)}t.gameData.mapId=l[s].id,t.rotationId&&(t.gameData.gameModeId=l[s].gameModeId,t.gameData.settings=getDefaultGameModeSettings(t.gameData.gameModeId),t.gameData.settings.bPrivate=t.bPrivate,null!=t.bHardcore&&(t.gameData.settings.bHardcore=t.bHardcore),t.gameModeId=t.gameData.gameModeId,log("Selected game mode:",chalk.yellow(t.gameModeId)))}if(t.gameData.mapId===Map.RANDOM){log("Getting random map...");var c=[Map.RIVERSIDE,Map.DISTRICT,Map.WAREHOUSE,Map.OUTPOST,Map.ESTATE,Map.FACTORY,Map.DOWNTURN,Map.SANDSTORM,Map.OVERGROWN,Map.AIRPORT];if(l)for(b=0;b<l.length;b++){var m=l[b],g=c.indexOf(m.id);g>=0&&c.splice(g,1)}t.gameData.mapId=c[MathUtil.Random(0,c.length-1)]}if(log("Selected map:",chalk.yellow(t.gameData.mapId)),t.bPrivate){var _=t.gameData.settings.bDebug,E=_?32:shared.maxPlayers[t.gameModeId]-1,I=Math.min(t.gameData.settings.bots,E),S=getAveragePlayerLevel(t.players),u=_?32:Lobby.MAX_PLAYERS;for(b=0;b<I&&t.players.length<u;b++){var A=t.gameData.settings.botSkill;A<0&&(A=Math.min(Math.floor(S/15),GameData.BOT_SKILL_HARD));var L=BotUtil.getLobbyData(A);t.players.push(L)}}else if(t.bAddBots){var v=t.maxPlayers-t.players.length;if(v>0)for(b=0;b<v;b++){(L=getBotPlayerForLobby(t))&&t.players.push(L)}}var p=t.gameData.settings.factions;if(p){var T=[GameData.FACTION_DELTA_FORCE,GameData.FACTION_GSG9,GameData.FACTION_GIGN,GameData.FACTION_OPFOR,GameData.FACTION_SPETSNAZ,GameData.FACTION_MILITIA],h=MathUtil.Random(0,T.length-1);p[0]=T[h],T.splice(h,1),p[1]=T[MathUtil.Random(0,T.length-1)],t.gameData.settings.factions=p}setLobbyTeams(t);break;case LobbyState.IN_PROGRESS:t.bLocked=!0,0==getNumRealPlayersInLobby(e).length?(log("Lobby is empty, reset state"),resetMapVotes(e),setLobbyState(e,LobbyState.WAITING)):(t.waitTimer=Lobby.WAIT_TIMER,stopLobbyInterval(e,"waitTimer"),intervals[e+"_waitTimer"]=setInterval(onPlayerWaitTimer,1e3,e));break;case LobbyState.INTERMISSION:removeBotsFromLobby(e),t.bLocked=!1,t.timer=Lobby.INTERMISSION_TIMER,stopLobbyInterval(e),intervals[e]=setInterval(onLobbyTimer,1e3,e),resetPlayers(t.players),t.maps=getRandomLobbyMaps(t.gameModeId,t.rotationModes),tryMerge(t)}}function getDummyBotPlayer(e,a){var t=BotUtil.getLobbyData(e);return t.bDummy=!0,t.id=getRandomUniqueId(),t.name=a||"Player"+MathUtil.Random(1,999),e>=3&&(t.prestige=MathUtil.Random(1,10)),t.card=titlecards_soldiers[MathUtil.Random(0,titlecards_soldiers.length-1)],t.callsign=null,t.bPremium=!0,t.latency=MathUtil.Random(10,100),t}function getBotPlayerForLobby(e){if(e){var a=1,t=getAveragePlayerLevel(e.players);return a=50==t?3:Math.min(2,Math.floor(t/15)),e.rotationId==GameMode.COMBAT_TRAINING&&(a=Math.min(a,GameData.BOT_SKILL_HARD)),BotUtil.getLobbyData(a)}return null}function stopLobbyInterval(e,a){var t=e;a&&(t+="_"+a);var r=intervals[t];r&&(clearInterval(r),delete intervals[e])}function retractLobbyMapVote(e,a){var t=getLobbyData(a);if(t){var r=t.maps;if(r)for(var o=0;o<r.length;o++){var n=r[o].votes;if(n){var i=n.indexOf(e);i>=0&&n.splice(i,1)}}}}function resetMapVotes(e){var a=getLobbyData(e);if(a){var t=a.maps;if(t)for(var r=0;r<t.length;r++)t[r].votes=[];delete a.votekick}}function getAllClanPlayers(e){async_getClanPlayers(e)}function getOnlinePlayersInClan(e){for(var a=getAllPlayers(),t=[],r=0;r<a.length;r++){var o=a[r];o.clan==e&&t.push(o)}return t}function getClanInvitablePlayers(){for(var e=getAllSockets(),a=[],t=0;t<e.length;t++){var r=e[t];r.info&&r.player&&r.info.username&&!r.player.clan&&!r.player.currentLobbyId&&r.player.bAllowPartyInvites&&a.push(r.player)}return a}function getAllPlayers(){var e=[];if(Object.keys(io.sockets.connected).forEach((function(a){var t=io.sockets.connected[a].player;if(t){var r=clone(t),o=getLobbyData(t.currentLobbyId);o&&(r.gameModeId=o.rotationId?o.rotationId:o.gameModeId,o.bPrivate&&(r.bPrivateLobby=!0),o.state==LobbyState.IN_PROGRESS&&(r.bInGame=!0)),e.push(r)}})),dummies)for(var a=0;a<dummies.length;a++)player=dummies[a],data=clone(player),curLobby=getLobbyData(player.currentLobbyId),curLobby&&(data.gameModeId=curLobby.rotationId?curLobby.rotationId:curLobby.gameModeId,curLobby.bPrivate&&(data.bPrivateLobby=!0),curLobby.state==LobbyState.IN_PROGRESS&&(data.bInGame=!0)),e.push(data);return e.sort(((e,a)=>e.prestige>a.prestige?-1:a.prestige<a.prestige?1:e.level>a.level?-1:a.level<a.level?1:0)),e}function getAllSockets(){var e=[];if(Object.keys(io.sockets.connected).forEach((function(a){var t=io.sockets.connected[a];t&&e.push(t)})),dummies)for(var a=0;a<dummies.length;a++)e.push({info:{version:Server.GAME_VERSION,host:"xwilkinx.com"},player:dummies[a]});return e.sort(((e,a)=>e.player.prestige>a.player.prestige?-1:e.player.prestige<a.player.prestige?1:e.player.level>a.player.level?-1:e.player.level<a.player.level?1:0)),e}function getNumClients(){return Object.keys(io.sockets.connected).length+(dummies?dummies.length:0)}function getSocketById(e){var a=io.sockets.connected[e];return a||getSocketByPlayerId(e)}function getSocketByPlayerId(e){for(var a=Object.keys(io.sockets.connected),t=0;t<a.length;t++){var r=a[t],o=io.sockets.connected[r];if(2==r.indexOf(e))return o}return null}function getSocketByUsername(e){for(var a=Object.keys(io.sockets.connected),t=0;t<a.length;t++){var r=io.sockets.connected[a[t]];if(r&&r.player&&r.info.username==e)return r}return null}function showClientDataFailedWindow(e){console.warn(tracePlayer(e),"Validation failed!"),e&&e.emit("showWindow",{titleText:"STR_MENU_MULTIPLAYER",messageText:"STR_ERROR_CLIENT_VALIDATION_FAILED_DESC",bShowOkayButton:!0})}function showMultiplayerLoginWindow(e){console.log(tracePlayer(e),"Player is not logged in"),e&&e.emit("showWindow",{id:"mpLogin",titleText:"STR_MENU_MULTIPLAYER",messageText:"STR_MULTIPLAYER_LOGIN",type:"TYPE_YES_NO",yesText:"STR_LOG_IN_REGISTER"})}function showBannedWindow(e){console.warn(tracePlayer(e),"Player is banned!"),e&&e.emit("showWindow",{titleText:"STR_MENU_MULTIPLAYER",messageText:"STR_ERROR_BANNED",bShowOkayButton:!0})}function getLobbyPlayerIds(e){var a=[];if(e)for(var t=0;t<e.players.length;t++)a.push(e.players[t].id);return a}function showWindowForSockets(e,a){if(e)for(var t=0;t<e.length;t++){var r=getSocketByPlayerId(e[t]);r&&r.emit("showWindow",a)}}function validateClient(e){return!!e&&(!!verifyClientPlayerData(e.player)||(showClientDataFailedWindow(e),e.disconnect(),!1))}function verifyClientPlayerData(e){if(e)try{if(e.level<0||e.level>GameData.MAX_LEVEL)return console.warn("Invalid level:",e.level),!1;if(e.prestige<0||e.prestige>GameData.MAX_PRESTIGE)return console.warn("Invalid prestige:",e.prestige),!1;var a=e.classes;if(!a)return console.warn("Invalid classes"),!1;for(var t=0;t<a.length;t++){var r=a[t];if(!r)return console.warn("Invalid class data"),!1;if(!isValidWeaponId(r.primary.id))return console.warn("Invalid primary id:",r.primary.id),!1;if(!isValidWeaponId(r.secondary.id))return console.warn("Invalid secondary id:",r.secondary.id),!1;if(!isValidWeaponId(r.equipment))return console.warn("Invalid equipment id:",r.equipment),!1;if("minigun"==r.primary.id||"minigun"==r.secondary.id)return console.warn("Using minigun"),!1;if("railgun"==r.primary.id||"railgun"==r.secondary.id)return console.warn("Using railgun"),!1}var o=e.killstreaks;if(!o)return!1;if(o.TYPE_ASSAULT.length>3)return console.warn("Invalid assault killstreaks:",o.TYPE_ASSAULT.length),!1;if(o.TYPE_SUPPORT.length>3)return console.warn("Invalid support killstreaks:",o.TYPE_SUPPORT.length),!1;if(o.TYPE_SPECIALIST.length>5)return console.warn("Invalid perk killstreaks:",o.TYPE_SPECIALIST.length),!1;var n=e.avatars;if(!n)return console.warn("Invalid avatars"),!1;var i=[GameData.FACTION_DELTA_FORCE,GameData.FACTION_OPFOR,GameData.FACTION_GSG9,GameData.FACTION_SPETSNAZ,GameData.FACTION_GIGN,GameData.FACTION_MILITIA];for(t=0;t<i.length;t++){if(!n[i[t]])return console.warn("Invalid avatar data"),!1}return!0}catch(e){return console.warn("An error occured while verifying client player data"),console.error(e),!1}return!1}function isValidWeaponId(e){if(weapons)for(var a=0;a<weapons.length;a++){let t=weapons[a];if(t.id===e)return!t.bHidden}return!1}function getLatestServerData(){for(var e=0,a=Object.keys(lobbies),t=0;t<a.length;t++)e+=lobbies[a[t]].length;var r=getAllPlayers();return{version:Server.VERSION,players:r.length,maxPlayers:serverSettings.maxClients,gamesInProgress:getLobbiesInProgress().length,lobbies:e}}function getPartyIndex(e){for(var a=Object.keys(parties),t=0;t<a.length;t++)if(parties[a[t]].id==e)return t;return null}function getAllLobbies(){for(var e=[],a=Object.keys(lobbies),t=0;t<a.length;t++)for(var r=a[t],o=0;o<lobbies[r].length;o++)e.push(lobbies[r][o]);return e}function getLobbyList(e){for(var a=[],t=Object.keys(lobbies),r=0;r<t.length;r++)for(var o=t[r],n=0;n<lobbies[o].length;n++){let t=lobbies[o][n];if("private"==o&&t.gameData.settings.bPrivate)continue;let r={id:t.id,bPrivate:"private"==o,numPlayers:getNumRealPlayersInLobby(t.id),maxPlayers:t.maxPlayers,gameModeId:t.gameModeId,rotationId:t.rotationId,state:t.state,bCanJoin:!!e&&canJoinLobby(t.id,e)==Lobby.JOIN_SUCCESS};t.state==LobbyState.IN_PROGRESS&&(r.mapId=t.gameData?t.gameData.mapId:null),a.push(r)}return a}function getAllPublicLobbies(){for(var e=[],a=Object.keys(lobbies),t=0;t<a.length;t++){var r=a[t];if("private"!==r)for(var o=0;o<lobbies[r].length;o++){let a=lobbies[r][o];e.push(a)}}return e}function getLobbiesInProgress(){for(var e=[],a=getAllLobbies(),t=0;t<a.length;t++){var r=a[t];r.state===LobbyState.IN_PROGRESS&&e.push(r)}return e}function getRandomUniqueId(){return Math.random().toString(36).substr(2,4)}function isRotationGameMode(e){switch(e){case GameMode.ROTATION_TEAM:case GameMode.ROTATION_SURVIVAL:case GameMode.GROUND_WAR:return!0}return!1}function isTeamGameMode(e){if(game_modes)for(var a=0;a<game_modes.length;a++){var t=game_modes[a];if(t.id===e)return t.bTeam}return!1}function shuffleArray(e){for(var a,t,r=e.length;0!==r;)t=Math.floor(Math.random()*r),a=e[r-=1],e[r]=e[t],e[t]=a;return e}function clone(e){return JSON.parse(JSON.stringify(e))}function convertMS(e){var a,t,r;return r=Math.floor(e/1e3),t=Math.floor(r/60),r%=60,a=Math.floor(t/60),t%=60,{day:Math.floor(a/24),hour:a%=24,minute:t,seconds:r}}function throttleSocket(e,a){return e&&rateLimiter.consume(e.id).then((()=>!0)).catch((a=>(disconnectSocket(e,{reason:"throttle"}),!1))),!1}function disconnectSocket(e,a){e&&(e.emit("disconnectInfo",a),e.disconnect())}server.listen(process.env.PORT||serverSettings.port,(function(){log("\nListening on "+server.address().family+" "+chalk.inverse(server.address().address)+":"+chalk.inverse(server.address().port)+"\n")})),log(chalk.yellow("Initializing server...")),initLobbies(),log(chalk.green("Done")),io.sockets.on("connection",(function(e){if(log(tracePlayer(e),chalk.green("Connected"),"|",getNumClients(),"connected"),stats.playersConnected++,stats.peakPlayersConnected=Math.max(stats.peakPlayersConnected,getNumClients()),e.player={id:genIdFromSocket(e),name:"Player",level:1,prestige:0},e.info={autoJoinAttempts:0},getNumClients()>serverSettings.maxClients)return console.warn("Maximum number of clients reached!",getNumClients()),e.emit("showWindow",{titleText:"STR_SERVER_FULL",messageText:"STR_SERVER_FULL_DESC",bShowOkayButton:!0}),void e.disconnect();e.emit("onConnect",Server.OFFICIAL,{welcomeMessage:serverSettings.welcomeMessage}),e.on("completeClanChallenge",(function(a){throttleSocket(e),actionLimiter.consume(e.id).then((()=>{if(e.player){var t=e.player.clan;t&&(log(tracePlayer(e),"Complete clan challenge",a),async_updateClanScore(t,1,0))}})).catch((e=>{}))})),e.on("updatePlayerData",(function(a){actionLimiter.consume(e.id).then((()=>{if(log(tracePlayer(e),"Update player data"),a){if(a.version){var t=Server.GAME_VERSION.split("."),r=a.version.split(".");if(3!=r.length||parseInt(r[0])<parseInt(t[0])||parseInt(r[1])<parseInt(t[1])||parseInt(r[2])<parseInt(t[2]))return log(tracePlayer(e),a.host,"Game version mismatch:",chalk.yellow("Required: "+Server.GAME_VERSION),"|",chalk.red("Client: "+a.version)),e.emit("showWindow",{id:"mp_mismatch",titleText:"STR_MENU_MULTIPLAYER",messageText:"STR_VERSION_MISMATCH_DESC",messageParams:[a.version,Server.GAME_VERSION],version:a.version,required:Server.GAME_VERSION,type:"TYPE_YES_NO",yesText:"STR_PLAY_LATEST_VERSION",yesURL:"https://xwilkinx.com/deadswitch-3"}),void e.disconnect();if(!a.username&&!a.steamId)return showMultiplayerLoginWindow(e),void e.disconnect();if(serverSettings.bannedUsernames&&a.username)for(var o=0;o<serverSettings.bannedUsernames.length;o++)if(a.username==serverSettings.bannedUsernames[o]){showBannedWindow(e),e.disconnect();break}if(serverSettings.bannedSteamIds&&a.steamId)for(o=0;o<serverSettings.bannedSteamIds.length;o++)if(a.steamId==serverSettings.bannedSteamIds[o]){showBannedWindow(e),e.disconnect();break}if(verifyClientPlayerData(a)){var n=e.player.latency,i=e.player.currentLobbyId,l=e.player.currentPartyId,s=getLobbyData(i);if(s&&s.game)e.player.level=a.level;else{if(e.player.version||(e.info.host=a.host,e.info.version=a.version),a.id=genIdFromSocket(e),e.player=clone(a),delete e.player.host,delete e.player.href,delete e.player.version,delete e.player.stats,e.player.latency=n,e.player.currentLobbyId=i,e.player.currentPartyId=l,s){var y=getLobbyPlayerById(i,getSocketPlayerId(e));y&&(y.name=e.player.name,y.level=e.player.level,y.prestige=e.player.prestige,y.card=e.player.card,y.callsign=e.player.callsign,y.avatars=e.player.avatars,y.killstreaks=e.player.killstreaks,io.sockets.in(i).emit("updateLobby",{players:s.players}))}if(l){var b=getPartyPlayerById(l,getSocketPlayerId(e));b&&(y.name=e.player.name,b.card=e.player.card,b.callsign=e.player.callsign),updatePartyClients(l)}}broadcastServerData()}else showClientDataFailedWindow(e),e.disconnect()}e.player&&e.info&&(void 0!==a.username&&(e.info.username=a.username,async_getClanForSocket(e)),void 0!==a.stats&&(e.stats=a.stats),void 0!==a.battlezone&&(e.player.battlezone=clone(a.battlezone)))}})).catch((e=>{}))})),e.on("updateClientLatency",(function(a){if(e.player){if(e.player.latency=a,a>=serverSettings.maxLatency)return void disconnectSocket(e,{reason:"latency"});if(e.player.currentLobbyId&&e.player.bReady){var t=getLobbyData(e.player.currentLobbyId);if(t)if(!t.bPrivate&&a>=serverSettings.maxLobbyLatency)removeSocketPlayerFromLobby(e,"latency");else{var r=t.game;r&&r.setPlayerLatency(getSocketPlayerId(e),a)}}}})),e.on("createClan",(function(a){if(throttleSocket(e),log(tracePlayer(e),"Wants to create clan:",a),e.player){if(e.player.clan)return void e.emit("onCreateClan",{bSuccess:!1,message:"You must leave your current clan before creating a new one.",key:"STR_ERROR_CLAN_LEAVE_CURRENT_CLAN"});if(!e.info.username)return void e.emit("onCreateClan",{bSuccess:!1,message:"You must be logged into a Deadswitch 3 account to create a new clan.",key:"STR_ERROR_CREATE_CLAN_NOT_LOGGED_IN"});async_createClan(e,a)}})),e.on("joinClan",(function(a){if(throttleSocket(e),log(tracePlayer(e),"Wants to join clan:",a),e.player){if(e.player.clan)return;e.info.username&&async_joinClan(e,a)}})),e.on("getClanData",(function(){throttleSocket(e),log(tracePlayer(e),"Wants to get clan data"),async_getClanData(e)})),e.on("leaveClan",(function(){throttleSocket(e),log(tracePlayer(e),"Wants to leave clan"),async_leaveClanBySocket(e)})),e.on("getPlayerData",(function(){throttleSocket(e),e.player&&e.emit("getPlayerData",e.player)})),e.on("requestQuit",(function(){if(throttleSocket(e),e.player){var a=e.player.currentLobbyId;log(tracePlayer(e),"Request quit in lobby",chalk.bgCyan(a)),(t=getParty(e.player.currentPartyId))&&t.hostPlayerId!=getSocketPlayerId(e)&&removePlayerFromParty(e);var t,r=getLobbyData(a);if(r)if(r.bPrivate)r.hostPlayerId==getSocketPlayerId(e)?(setLobbyState(a,LobbyState.WAITING_HOST),io.sockets.in(a).emit("updateLobby",getSafeLobbyData(r))):removeSocketPlayerFromLobby(e,"client_quit");else(t=getParty(e.player.currentPartyId))&&t.hostPlayerId==getSocketPlayerId(e)&&t.players.length>1&&removePlayerFromParty(e),removeSocketPlayerFromLobby(e,"client_quit")}})),e.on("requestGame",(function(){throttleSocket(e);var a=e.player.currentLobbyId;log(tracePlayer(e),"requests game in",chalk.bgCyan(a));var t=getLobbyData(a);if(t){var r=t.game;if(r){log(chalk.bgCyan(a),"Game in progress");var o=[];if(t.bAddBots){for(var n=0,i=0;i<t.players.length;i++){if(t.players.length>t.maxPlayers)(_=t.players[i]).bBot&&_.team==e.player.team&&(r.requestEvent({eventId:GameServer.EVENT_PLAYER_LEAVE,reason:"kicked",playerId:_.id}),t.players.splice(i,1),n++)}if(!n)for(i=0;i<t.players.length;i++){if(t.players.length>t.maxPlayers)(_=t.players[i]).bBot&&(r.requestEvent({eventId:GameServer.EVENT_PLAYER_LEAVE,reason:"kicked",playerId:_.id}),t.players.splice(i,1),n++)}}o.push(r.getInitEventData()),r.addPlayer(clone(e.player)),o.push(r.getGameModeEventData()),r.matchInProgress()&&o.push(r.getGameStartEventData());var l=r.getPlayerStates();for(i=0;i<l.length;i++){let a=l[i];a.id!=getSocketPlayerId(e)&&o.push({eventId:GameServer.EVENT_PLAYER_JOIN,playerId:a.id,data:a,bSilent:!0})}var s=r.getObjectsEventData();for(i=0;i<s.length;i++)o.push(s[i]);log(o.length,"events"),e.emit("gameEvent",{eventId:GameServer.EVENT_BATCH,lobbyId:a,items:o})}else{var y=t.players,b=0,d=getNumBotsInLobby(a),c=getNumDummiesInLobby(a),m=y.length-(d+c);for(i=0;i<y.length;i++)ps=y[i],ps.id==getSocketPlayerId(e)?(ps.bReady=!0,b++):ps.bReady&&b++;if(log(chalk.bgCyan(a),"Players ready:",b,"/",m),0==m)endLobbyGame(a,!1);else{var g=[];for(i=0;i<y.length;i++){var _=y[i];g.push(_)}if(io.sockets.in(a).emit("updatePlayersReady",{players:g,numReady:b,numNeeded:m}),b==m){log(chalk.bgCyan(a),chalk.green("All players ready"));var E=t.gameData;E.maxPlayers=t.maxPlayers,E.bPrivate=t.bPrivate,onInitGame(a,E)}}}}})),e.on("requestEvent",(function(a){if(e.player&&a){throttleSocket(e,a);var t=!1;if(gameLimiter.consume(e.id).then((()=>{t=!1})).catch((e=>{t=!0})),!t){var r=getGame(e.player.currentLobbyId);if(r){var o=!0,n=!0;switch(a.eventId){case GameServer.EVENT_PLAYER_UPDATE_INVENTORY:-1==e.id.indexOf(a.pawnId)&&(o=!1);break;case GameServer.EVENT_PLAYER_UPDATE_CONTROLLABLE:case GameServer.EVENT_PLAYER_INPUT:case GameServer.EVENT_BATTLEZONE:case GameServer.EVENT_SWITCH_TEAMS:-1==e.id.indexOf(a.playerId)&&(o=!1,n="playerController"!=a.playerId);break;case GameServer.EVENT_PLAYER_EARN_KILLSTREAK:o=!1,n=!0}o||(console.warn(tracePlayer(e),"Cheat detected",a),n&&e.disconnect()),o&&r.requestEvent(a)}}}else e.disconnect()})),e.on("joinParty",(function(a){if(throttleSocket(e),log(tracePlayer(e),"Wants to join party",chalk.bgCyan(a)),e.player.currentPartyId)log("Already in party!");else{var t=getParty(a);if(t)switch(canJoinParty(a,e)){case Party.JOIN_SUCCESS:joinParty(a,e);var r=getSocketByPlayerId(t.hostPlayerId);if(r)if(r.player.currentLobbyId)switch(canJoinLobby(r.player.currentLobbyId,e)){case Lobby.JOIN_SUCCESS:joinLobby(r.player.currentLobbyId,e)}break;case Party.JOIN_FAIL_CAPACITY:e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_PARTY_MAX_CAPACITY_DESC",bShowOkayButton:!0});break;case Lobby.JOIN_FAIL_CAPACITY:e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_CUSTOM_LOBBY_MAX_CAPACITY_DESC",bShowOkayButton:!0});break;case Lobby.JOIN_FAIL_LOCKED:e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_PARTY_LOCKED_DESC",bShowOkayButton:!0});break;default:e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_ERROR_DESC",bShowOkayButton:!0})}else e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_PARTY_NON_EXISTANT_DESC",messageParams:[a],highlights:[a],bShowOkayButton:!0})}})),e.on("requestParty",(function(){if(throttleSocket(e),log(tracePlayer(e),"Requests party data"),e.player&&e.player.currentPartyId){var a=getParty(e.player.currentPartyId);a&&e.emit("updateParty",a)}})),e.on("leaveParty",(function(a){throttleSocket(e),log(tracePlayer(e),"Wants to leave party",chalk.bgCyan(e.player.currentPartyId)),removePlayerFromParty(e)})),e.on("getPlayerList",(function(){throttleSocket(e),actionLimiter.consume(e.id).then((()=>{log(tracePlayer(e),"Wants to get player list"),e.emit("receivePlayerList",{id:"players_all",players:getAllPlayers()})})).catch((e=>{}))})),e.on("getClanPlayerList",(function(){throttleSocket(e),actionLimiter.consume(e.id).then((()=>{e.player.clan&&(log(tracePlayer(e),"Wants to get clan player list"),getAllClanPlayers(e))})).catch((e=>{}))})),e.on("getClanInvitePlayerList",(function(){throttleSocket(e),actionLimiter.consume(e.id).then((()=>{e.player.clan&&(log(tracePlayer(e),"Wants to get clan invite player list"),e.emit("receivePlayerList",{id:"players_clan_invite",players:getClanInvitablePlayers()}))})).catch((e=>{}))})),e.on("getLobbyList",(function(){throttleSocket(e),actionLimiter.consume(e.id).then((()=>{log(tracePlayer(e),"Wants to get lobby list"),e.emit("receiveLobbyList",getLobbyList(e))})).catch((e=>{}))})),e.on("getClanList",(function(){throttleSocket(e),actionLimiter.consume(e.id).then((()=>{log(tracePlayer(e),"Wants to get clan list"),async_getClanList(e)})).catch((e=>{}))})),e.on("getPlayerInfo",(function(a){if(throttleSocket(e),log(tracePlayer(e),"Wants to get player info:",a),dummies)for(var t=0;t<dummies.length;t++){var r=dummies[t];if(r.id==a){var o={player:r,stats:{xp:r.level*MathUtil.Random(1e3,1e4),kills:MathUtil.Random(100,1e4),deaths:MathUtil.Random(50,1e3),challengesCompleted:MathUtil.Random(0,100),games_played:MathUtil.Random(10,1e3),games_won:MathUtil.Random(0,500)}};return(i=getLobbyData(r.currentLobbyId))&&(o.gameModeId=i.rotationId?i.rotationId:i.gameModeId,i.bPrivate&&(o.bPrivateLobby=!0),i.state==LobbyState.IN_PROGRESS&&(o.bInGame=!0),o.bCanJoin=canJoinLobby(i.id,e)==Lobby.JOIN_SUCCESS&&!i.gameData.settings.bPrivate),void e.emit("receivePlayerInfo",o)}}var n=getSocketByPlayerId(a);if(n){var i;o={player:n.player,stats:n.stats};(i=getLobbyData(n.player.currentLobbyId))&&(o.gameModeId=i.rotationId?i.rotationId:i.gameModeId,i.bPrivate&&(o.bPrivateLobby=!0),i.state==LobbyState.IN_PROGRESS&&(o.bInGame=!0),o.bCanJoin=canJoinLobby(i.id,e)==Lobby.JOIN_SUCCESS&&!i.gameData.settings.bPrivate),e.emit("receivePlayerInfo",o)}})),e.on("getChatHistory",(function(){throttleSocket(e),log(tracePlayer(e),"Wants to get chat history"),e.emit("receiveChatHistory",chatHistory)})),e.on("inviteToParty",(function(a){throttleSocket(e);var t=e.player?e.player.currentPartyId:null;if(t){var r=getSocketByPlayerId(a);r&&r.player&&r.player.bAllowPartyInvites&&r.player.currentPartyId!=t&&(log(tracePlayer(e),"Wants to invite",tracePlayer(r),"to their party"),r.emit("serverMessage",{type:"party_invite",partyId:t,player:e.player,id:t}))}})),e.on("inviteToClan",(function(a){throttleSocket(e);var t=e.player.clan;if(t){var r=getSocketByPlayerId(a);r&&r.player&&r.player.bAllowPartyInvites&&(r.player.clan||(log(tracePlayer(e),"Wants to invite",tracePlayer(r),"to clan"),r.emit("serverMessage",{type:"clan_invite",clan:t,player:e.player,id:t})))}})),e.on("joinLobby",(function(a){throttleSocket(e),a&&("string"==typeof a?joinLobbyByGameModeId(e,a,!1):joinLobbyByGameModeId(e,a.gameModeId,a.bBattlezone))})),e.on("joinLobbyById",(function(a){throttleSocket(e),joinLobbyById(e,a)})),e.on("createParty",(function(){throttleSocket(e),log(tracePlayer(e),"Wants to create party"),createParty(e)})),e.on("createPrivateLobby",(function(){if(throttleSocket(e),log(tracePlayer(e),"Wants to create private lobby"),validateClient(e))if(e.player.currentLobbyId)removeSocketPlayerFromLobby(e,"create_private_lobby");else{var a=e.player.currentPartyId;if(a)if((t=getParty(a))&&getSocketPlayerId(e)!=t.hostPlayerId)return;if(lobbies.private.length<serverSettings.maxCustomLobbies){var t,r="L-"+getRandomUniqueId();if(createPrivateLobby(r),t=getParty(e.player.currentPartyId))for(i=0;i<t.players.length;i++){var o=getSocketByPlayerId(t.players[i].id);canJoinLobby(r,o)==Lobby.JOIN_SUCCESS&&joinLobby(r,o)}else joinLobby(r,e),sendChatMessage(null,{bServer:!0,messageText:e.player.name+" created a new custom lobby."})}else e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_CUSTOM_LOBBY_MAX_CAPACITY_DESC",bShowOkayButton:!0})}})),e.on("changePrivateGameSettings",(function(a){if(throttleSocket(e),e.player){if(log(tracePlayer(e),"Wants to change private game settings",chalk.bgCyan(e.player.currentLobbyId)),log(a),a){var t=getLobbyData(e.player.currentLobbyId);if(t){if(t.hostPlayerId!=getSocketPlayerId(e))return void disconnectSocket(e,{reason:"kicked"});if(t.bPrivate){for(var r=t.id,o=t.gameData,n=o.settings.bDebug,i=o.settings.bPrivate,l=o.settings.bots,s=o.settings.botSkill,y=o.settings.botTeam,b=o.settings.difficulty,d=Object.keys(a),c=0;c<d.length;c++){var m=d[c];if(a.bSettings){if("bSettings"!==m){var g=a[m];switch(m){case"bDebug":log("Setting private game debug:",g);break;case"botTeam":g=Math.max(-1,Math.min(1,g));break;case"botSkill":g=Math.max(-1,Math.min(4,g));break;case"bots":g=Math.max(0,g);break;case"timeLimit":case"respawnTime":case"scoreLimit":case"bombTimerMax":g=Math.max(1,g)}o.settings[m]=g}}else if(o[m]=a[m],"gameModeId"==m){switch(delete o.operation,delete o.operationId,delete o.bSurvival,delete o.bOperation,delete o.bSandbox,t.gameModeId=a[m],o.settings=getDefaultGameModeSettings(a[m]),o.settings.bAutoBalance=!1,o.settings.bDebug=n,o.settings.bPrivate=null==i||i,o.settings.bots=l,o.settings.botSkill=s,o.settings.botTeam=y,a[m]){case GameMode.BATTLEZONE:o.bBattlezone=!0,o.bRanked=!0,o.settings.bots=0;break;case GameMode.SANDBOX:o.bRanked=!1,o.bSandbox=!0,o.settings.bots=0;break;case GameMode.SURVIVAL_BASIC:case GameMode.SURVIVAL_CHAOS:case GameMode.SURVIVAL_UNDEAD:case GameMode.SURVIVAL_STAKEOUT:case GameMode.SURVIVAL_PRO:o.bRanked=!1,o.bSurvival=!0,o.settings.bots=0;break;case GameMode.OPERATION:o.operationId="op_riverside_assault",o.bRanked=!0,o.settings.bots=0,o.settings.difficulty=b||1;break;default:o.bRanked=!0}log("Loaded default game mode settings"),t.bTeamSelection=isTeamGameMode(o.gameModeId)}}if(log("Updated",d.length,"keys"),t.game)return void console.warn("Game exists in private lobby while updating settings!");io.sockets.in(r).emit("updateLobby",getSafeLobbyData(t))}}}}else disconnectSocket(e,{reason:"Error"})})),e.on("startPrivateGame",(function(){throttleSocket(e),log(tracePlayer(e),"Wants to start private game");var a=getLobbyData(e.player.currentLobbyId);if(a){if(a.hostPlayerId!=getSocketPlayerId(e))return;var t=a.id;if(a.bPrivate)if(a.state===LobbyState.STARTING)setLobbyState(t,LobbyState.WAITING_HOST),io.sockets.in(t).emit("updateLobby",getSafeLobbyData(a));else{var r=a.players.length,o=a.gameData.settings.bDebug?Lobby.MAX_PLAYERS:shared.maxPlayers[a.gameModeId];r>o?e.emit("showWindow",{titleText:"STR_TOO_MANY_PLAYERS",messageText:"STR_TOO_MANY_PLAYERS_DESC",messageParams:[o],bShowOkayButton:!0}):r<1?e.emit("showWindow",{titleText:"STR_NOT_ENOUGH_PLAYERS",messageText:"STR_NOT_ENOUGH_PLAYERS_DESC",bShowOkayButton:!0}):verifyPrivateLobbyTeams(a)?a.state===LobbyState.WAITING_HOST&&(setLobbyState(t,LobbyState.STARTING),intervals[t]||(a.timer=Lobby.COUNTDOWN_STARTING_PRIVATE,intervals[t]=setInterval(onLobbyTimer,1e3,t)),io.sockets.in(t).emit("updateLobby",getSafeLobbyData(a))):e.emit("showWindow",{titleText:"STR_INVALID_TEAMS",messageText:"STR_INVALID_TEAMS_DESC",bShowOkayButton:!0})}else log(chalk.red("Insufficient permissions"))}})),e.on("setPrivatePlayerTeam",(function(a,t){throttleSocket(e),log(tracePlayer(e),"Wants to set private player team",tracePlayer(getSocketByPlayerId(a)),t);var r=getLobbyData(e.player.currentLobbyId);if(r){if(r.hostPlayerId!=getSocketPlayerId(e))return;if(r.bPrivate){var o=getLobbyPlayerById(r.id,a);o&&(t>=0?o.desiredTeam=Math.min(t,1):delete o.desiredTeam,io.sockets.in(r.id).emit("updateLobby",{players:r.players}))}else log(chalk.red("Insufficient permissions"))}})),e.on("kickPrivatePlayer",(function(a){throttleSocket(e),log(tracePlayer(e),"Wants to kick private player",a);var t=getParty(e.player.currentPartyId);if(t){if(t.hostPlayerId!=getSocketPlayerId(e))return;(o=getSocketByPlayerId(a))&&(removePlayerFromParty(o),removeSocketPlayerFromLobby(o,"kicked"))}else{var r=getLobbyData(e.player.currentLobbyId);if(r){if(!r.bPrivate||r.hostPlayerId!=getSocketPlayerId(e))return;var o;(o=getSocketByPlayerId(a))&&removeSocketPlayerFromLobby(o,"kicked")}}})),e.on("kickClanPlayer",(function(a){if(throttleSocket(e),log(tracePlayer(e),"Wants to kick clan player",a),e.player.clan&&e.player.bClanLeader){var t=getSocketByPlayerId(a);t?(log("Kicking socket player..."),async_leaveClanBySocket(t)):(log("Kicking by username..."),async_leaveClanByUsername(e,a))}})),e.on("joinPrivateLobby",(function(a){if(throttleSocket(e),e.player)if(log(tracePlayer(e),"Wants to join private lobby",chalk.bgCyan(a)),e.player.currentLobbyId)removeSocketPlayerFromLobby(e,"joining_private_lobby");else{var t=getLobbyData(a);if(t){var r=t.id;switch(canJoinLobby(r,e)){case Lobby.JOIN_SUCCESS:var o=getParty(e.player.currentPartyId);if(o)for(var n=0;n<o.players.length;n++){var i=getSocketByPlayerId(o.players[n].id);canJoinLobby(r,i)==Lobby.JOIN_SUCCESS&&joinLobby(r,i)}else joinLobby(r,e);break;case Lobby.JOIN_FAIL_LOCKED:e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_CUSTOM_LOBBY_LOCKED_DESC",bShowOkayButton:!0});break;case Lobby.JOIN_FAIL_CAPACITY:e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_CUSTOM_LOBBY_MAX_CAPACITY_DESC",bShowOkayButton:!0})}}else e.emit("showWindow",{titleText:"STR_ERROR",messageText:"STR_CUSTOM_LOBBY_NON_EXISTANT_DESC",messageParams:[a],highlights:[a],bShowOkayButton:!0})}})),e.on("votekick",(function(a){throttleSocket(e),serverSettings.bAllowVotekick&&(log(tracePlayer(e),"wants to votekick player",tracePlayer(getSocketByPlayerId(a))),a&&e.player&&e.player.currentLobbyId&&votekickPlayer(e.player.currentLobbyId,e.id,a))})),e.on("sendLobbyChatMessage",(function(a,t){if(e.player&&(throttleSocket(e),t)){var r=t.replace(/<(?:.|\n)*?>/gm,"");if(0==r.length)return;var o=e.player.currentLobbyId;r=smile.checkText(r),chatLimiter.consume(e.id).then((()=>{log(tracePlayer(e),chalk.cyan("<Chat: "+(o||"Global")+">"),r),r.split(" ")[0];for(var a=r.toLowerCase(),t=null,n=getAllLobbies(),i=0;i<n.length;i++){let e=n[i];if(a.indexOf(e.id.toLowerCase())>=0){t=e.id;break}}var l=null;if(!t){var s=Object.keys(parties);for(i=0;i<s.length;i++){let e=parties[s[i]];a.indexOf(e.id.toLowerCase())>=0&&(l=e.id)}}sendChatMessage(o,{playerId:e.player.id,currentPartyId:e.player.currentPartyId,bAdmin:e.player.bAdmin,bClanLeader:e.player.bClanLeader,playerText:e.player.name,clan:e.player.clan,messageText:r,lobbyId:t,partyId:l})})).catch((a=>{sendChatMessageToSocket(e.id,{messageText:"You've sent too many messages."})}))}})),e.on("setLobbyMapVote",(function(a,t){throttleSocket(e),log(tracePlayer(e),"Map vote",chalk.yellow(t));var r=getLobbyData(a);if(r){var o=r.maps;if(o){for(var n=0;n<o.length;n++){var i=o[n],l=i.votes,s=l.indexOf(getSocketPlayerId(e));s>=0?l.splice(s,1):i.id==t&&l.push(getSocketPlayerId(e))}io.sockets.in(a).emit("updateLobby",{timer:r.timer,maps:r.maps})}else console.warn("Invalid maps reference",r)}})),e.on("leaveLobby",(function(){if(throttleSocket(e),e.player){var a=e.player.currentLobbyId;if(a)if(log(tracePlayer(e),"Wants to leave lobby",chalk.bgCyan(a)),getLobbyData(a)){var t=getParty(e.player.currentPartyId);if(t)if(t.hostPlayerId==getSocketPlayerId(e))for(var r=0;r<t.players.length;r++){removeSocketPlayerFromLobby(getSocketByPlayerId(t.players[r].id),"party_host_leave")}else removePlayerFromParty(e),removeSocketPlayerFromLobby(e,"leave");else removeSocketPlayerFromLobby(e,"leave")}else console.warn("socket.on(leaveLobby) --\x3e Lobby doesn't exist:",e.player.currentLobbyId),e.player.currentLobbyId&&removeSocketPlayerFromLobby(e,"leave")}})),e.on("getLobbyData",(function(a){throttleSocket(e);var t=getSafeLobbyDataById(a);e.emit("getLobbyData",t)})),e.on("getServerData",(function(){throttleSocket(e),e.emit("getServerData",getLatestServerData())})),e.on("getCurrentLobbyData",(function(){throttleSocket(e);var a=getLobbyData(e.player.currentLobbyId);a&&e.emit("updateLobby",getSafeLobbyData(a))})),e.on("disconnect",(function(){e.player.currentLobbyId&&removeSocketPlayerFromLobby(e,"disconnect"),e.player.currentPartyId&&removePlayerFromParty(e),log(tracePlayer(e),chalk.red("Disconnected"),"|",getNumClients(),"connected"),delete e.player,delete e.info,broadcastServerData()}))}));var BotUtil={getLobbyData:function(e){var a=1,t=0,r=e;switch(e){case 1:a=MathUtil.Random(10,30);break;case 2:a=MathUtil.Random(30,49);break;case 3:a=GameData.MAX_LEVEL;break;case 4:a=GameData.MAX_LEVEL,t=GameData.MAX_PRESTIGE;break;case 0:default:a=MathUtil.Random(1,10)}var o=botnames[r],n=[GameData.FACTION_DELTA_FORCE,GameData.FACTION_GSG9,GameData.FACTION_GIGN,GameData.FACTION_OPFOR,GameData.FACTION_SPETSNAZ,GameData.FACTION_MILITIA];return{id:getRandomUniqueId(),name:"BOT "+o[MathUtil.Random(0,o.length-1)],bBot:!0,botSkill:r,level:a,prestige:t,card:"wilkin",callsign:"soldier_1",avatars:{usmc:BotUtil.getAvatarData(GameData.FACTION_DELTA_FORCE),gsg9:BotUtil.getAvatarData(GameData.FACTION_GSG9),gign:BotUtil.getAvatarData(GameData.FACTION_GIGN),opfor:BotUtil.getAvatarData(GameData.FACTION_OPFOR),rus:BotUtil.getAvatarData(GameData.FACTION_SPETSNAZ),militia:BotUtil.getAvatarData(GameData.FACTION_MILITIA),preferred:n[MathUtil.Random(0,n.length-1)]}}},getAvatarData:function(e){var a=[Character.HAIR_COLOUR_BROWN,Character.HAIR_COLOUR_BROWN_LIGHT,Character.HAIR_COLOUR_BLACK,Character.HAIR_COLOUR_BLONDE,Character.HAIR_COLOUR_GINGER],t=[Character.HAIR_SHORT,Character.HAIR_LONG,Character.HAIR_BUZZED,Character.HAIR_BALD],r=[Character.HEAD_NONE];switch(e){case GameData.FACTION_DELTA_FORCE:r=[Character.HEAD_NONE,Character.HEAD_USMC_HELMET,Character.HEAD_USMC_HELMET_TACTICAL,Character.HEAD_USMC_CAP,Character.HEAD_USMC_BOONIE,Character.HEAD_DELTA_MEDIC_HELMET];break;case GameData.FACTION_GSG9:r=[Character.HEAD_NONE,Character.HEAD_GSG9_HELMET,Character.HEAD_GSG9_HELMET_2,Character.HEAD_GSG9_HELMET_3,Character.HEAD_GSG9_MEDIC_HELMET];break;case GameData.FACTION_GIGN:r=[Character.HEAD_NONE,Character.HEAD_GIGN_HELMET,Character.HEAD_GIGN_HELMET_2,Character.HEAD_GIGN_CAP,Character.HEAD_GIGN_MEDIC_HELMET];break;case GameData.FACTION_OPFOR:r=[Character.HEAD_NONE,Character.HEAD_OPFOR_SCARF,Character.HEAD_OPFOR_HELMET_2,Character.HEAD_OPFOR_HELMET,Character.HEAD_MEDIC_HELMET];break;case GameData.FACTION_SPETSNAZ:r=[Character.HEAD_NONE,Character.HEAD_RUS_HELMET,Character.HEAD_RUS_TOQUE,Character.HEAD_RUS_SCARF,Character.HEAD_MEDIC_HELMET];break;case GameData.FACTION_MILITIA:r=[Character.HEAD_NONE,Character.HEAD_MILITIA_BANDANA,Character.HEAD_MILITIA_RADIO,Character.HEAD_MILITIA_BAND,Character.HEAD_MEDIC_HELMET]}var o=[Character.FACEWEAR_NONE,Character.FACEWEAR_MASK,Character.FACEWEAR_BALACLAVA,Character.FACEWEAR_GAITER],n=[Character.EYEWEAR_NONE];switch(e){case GameData.FACTION_OPFOR:case GameData.FACTION_SPETSNAZ:var i=Character.VOICE_RU;break;case GameData.FACTION_GIGN:case GameData.FACTION_MILITIA:i=Character.VOICE_UK;break;case GameData.FACTION_DELTA_FORCE:case GameData.FACTION_GSG9:i=MathUtil.RandomBoolean()?Character.VOICE_A:Character.VOICE_B}var l={};l[Character.TYPE_HAIR_COLOUR]=a[MathUtil.Random(0,a.length-1)],l[Character.TYPE_HAIR]=t[MathUtil.Random(0,t.length-1)],l[Character.TYPE_BEARD]=Character.BEARD_NONE,l[Character.TYPE_HEAD]=r[MathUtil.Random(0,r.length-1)],l[Character.TYPE_FACEWEAR]=o[MathUtil.Random(0,o.length-1)],l[Character.TYPE_EYEWEAR]=n[MathUtil.Random(0,n.length-1)];var s=e,y=["","_recon","_para","_rocketier","_heavy","_kevlar"];return l[Character.TYPE_BODY]=s+y[MathUtil.Random(0,y.length-1)],l[Character.TYPE_VOICE]=i,l}};function getSocketPlayerId(e){return e?e.player?e.player.id:e.id:null}function onUpdatePlayerClan(e){if(e){var a=getLobbyData(e.player.currentLobbyId);if(a){var t=a.id,r=a.game;if(r)r.requestEvent({eventId:GameServer.EVENT_PLAYER_UPDATE,playerId:getSocketPlayerId(e),data:{clan:e.player.clan?e.player.clan:null}});else{var o=getLobbyPlayerById(t,getSocketPlayerId(e));o&&(o.clan=e.player.clan,io.sockets.in(t).emit("updateLobby",{players:a.players}))}}var n=e.player.currentPartyId;if(n){var i=getPartyPlayerById(n,getSocketPlayerId(e));i&&(i.clan=e.player.clan),updatePartyClients(n)}e.emit("onUpdatePlayerData",e.player),broadcastServerData(),e.player.clan&&broadcastClanUpdate(e.player.clan)}}function broadcastClanUpdate(e){for(var a=getOnlinePlayersInClan(e),t=0;t<a.length;t++){var r=getSocketByPlayerId(a[t].id);r&&r.emit("onClanUpdated")}}async function async_updateClanScore(e,a,t){return null}async function async_leaveClanByUsername(e,a){return null}async function async_leaveClanBySocket(e){return null}async function async_getClanPlayers(e){return null}async function async_getClanData(e){return null}async function async_getClanList(e){return null}async function async_getClanForSocket(e){}async function async_joinClan(e,a){return null}async function async_createClan(e,a){return null}function addDummyToLobby(e,a){a&&(a.players.push(e),e.currentLobbyId=a.id,checkLobbyReady(a.id))}function createDummyPlayer(e){let a=getDummyBotPlayer(MathUtil.Random(0,3),e),t=getAllPublicLobbies();var r=[1,1,2,2,3,5];if(1==MathUtil.Random(1,4))for(var o=0;o<10;o++){let e=t[r[MathUtil.Random(0,r.length-1)]];if(e&&e.players.length<e.maxPlayers){addDummyToLobby(a,e);break}}return dummies.push(a),a}function removeDummyPlayer(){dummies&&(dummies[0]&&dummies.splice(0,1))}var dummies=[];if(serverSettings.numBots>0){log(chalk.yellow("\nAdding",serverSettings.numBots,"bots...")),shuffleArray(bots);for(i=0;i<serverSettings.numBots;i++)createDummyPlayer(bots[i]);log(chalk.green("Done"))}if(serverSettings.maxUptimeHours>0){log(chalk.yellow("\nMax Uptime Enabled")),log("Server will stop after",serverSettings.maxUptimeHours,"hours");var iterations=0,iterationTime=36e5;setInterval((function(){iterations++,(0==getLobbiesInProgress().length||0==getNumClients()||iterations>=serverSettings.maxUptimeHours)&&(log("Max uptime reached"),process.exit(0))}),iterationTime)}
